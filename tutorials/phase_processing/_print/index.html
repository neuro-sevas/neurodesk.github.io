<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.94.0"><link rel=canonical type=text/html href=https://neuro-sevas/neurodesk.github.io/tutorials/phase_processing/><link rel=alternate type=application/rss+xml href=https://neuro-sevas/neurodesk.github.io/tutorials/phase_processing/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/neurodesk.github.io/favicons/favicon.ico><link rel=apple-touch-icon href=/neurodesk.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/neurodesk.github.io/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/neurodesk.github.io/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-192x192.png sizes=192x192><title>MRI phase Processing | NeuroDesk</title><meta name=description content="Tutorials about processing MRI phase
"><meta property="og:title" content="MRI phase Processing"><meta property="og:description" content="Tutorials about processing MRI phase
"><meta property="og:type" content="website"><meta property="og:url" content="https://neuro-sevas/neurodesk.github.io/tutorials/phase_processing/"><meta property="og:site_name" content="NeuroDesk"><meta itemprop=name content="MRI phase Processing"><meta itemprop=description content="Tutorials about processing MRI phase
"><meta name=twitter:card content="summary"><meta name=twitter:title content="MRI phase Processing"><meta name=twitter:description content="Tutorials about processing MRI phase
"><link rel=preload href=/neurodesk.github.io/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css as=style><link href=/neurodesk.github.io/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=/neurodesk.github.io/css/prism.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-221108279-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/neurodesk.github.io/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">NeuroDesk</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/neurodesk.github.io/docs/how-to-cite-us/><span>Cite</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/neurodesk.github.io/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/neurodesk.github.io/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/neurodesk.github.io/applications/><span>Applications</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/neurodesk.github.io/developers/><span>Developers</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/neurodesk.github.io/tutorials/><span class=active>Tutorials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/NeuroDesk target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://twitter.com/neuro_desk target=_blank><span>News</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/neurodesk.github.io/offline-search-index.49958059539d8b508473f889b67a882f.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/neurodesk.github.io/tutorials/phase_processing/>Return to the regular view of this page</a>.</p></div><h1 class=title>MRI phase Processing</h1><div class=lead>Tutorials about processing MRI phase</div><ul><li>1: <a href=#pg-ed3153aa84e753252b1a096df3880cc5>Quantitative Susceptibility Mapping</a></li><li>2: <a href=#pg-3174433b4a44ad886176920795e9074f>SWI</a></li><li>3: <a href=#pg-359022268721811f542c4065f38891ed>Unwrapping</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-ed3153aa84e753252b1a096df3880cc5>1 - Quantitative Susceptibility Mapping</h1><div class=lead>Example workflow for Quantitative Susceptibility Mapping</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=quantitative-susceptibility-mapping-in-qsmxt>Quantitative Susceptibility Mapping in QSMxT</h2><p>Neurodesk includes QSMxT, a complete and end-to-end QSM processing and analysis framework that excels at automatically reconstructing and processing QSM for large groups of participants.</p><p>QSMxT provides pipelines implemented in Python that:</p><ol><li>Automatically convert DICOM data to the Brain Imaging Data Structure (BIDS)</li><li>Automatically reconstruct QSM, including steps for:<ol><li>Robust masking without anatomical priors</li><li>Phase unwrapping (Laplacian based)</li><li>Background field removal + dipole inversion (<code>tgv_qsm</code>)</li><li>Multi-echo combination</li></ol></li><li>Automatically generate a common group space for the whole study, as well as average magnitude and QSM images that facilitate group-level analyses.</li><li>Automatically segment T1w data and register them to the QSM space to extract quantitative values in anatomical regions of interest.</li><li>Export quantitative data to CSV for all subjects using the automated segmentations, or a custom segmentation in the group space (we recommend ITK snap).</li></ol><p>If you use QSMxT for a study, please cite <a href=https://doi.org/10.1101/2021.05.05.442850>https://doi.org/10.1101/2021.05.05.442850</a> (for QSMxT) and <a href=http://www.ncbi.nlm.nih.gov/pubmed/25731991>http://www.ncbi.nlm.nih.gov/pubmed/25731991</a> (for TGVQSM)</p><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>export PATH=$PATH:~/.local/bin
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c clone /neurodesktop-storage/qsmxt-demo
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub1/GR_M_5_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub1/GR_P_6_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub2/GR_M_5_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub2/GR_P_6_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span></code></pre></div><h2 id=qsmxt-usage>QSMxT Usage</h2><p>Start QSMxT (in this demo we used 1.1.9) from the applications menu in the desktop (<em>Neurodesk</em> > <em>Quantitative Imaging</em> > <em>qsmxt</em>)</p><ol><li>Convert DICOM data to BIDS:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /neurodesktop-storage/qsmxt-demo
</span></span><span style=display:flex><span>python3 /opt/QSMxT/run_0_dicomSort.py /neurodesktop-storage/qsmxt-demo/dicoms 00_dicom
</span></span><span style=display:flex><span>python3 /opt/QSMxT/run_1_dicomConvert.py 00_dicom 01_bids
</span></span></code></pre></div></li></ol><p>This will bring up an interactive question to ask you which sequence your QSM data are. It will automatically detect the QSM sequence if it has qsm or t2star in the protocol name or you can use the command line argument <code>--t2starw_series_patterns</code> to specify. This demo data comes without a structural scan (automatically recognized with t1w in the name, or specified with <code>--t1w_series_patterns</code>, so hit Enter to continue when it asks you to identify which scan the T1w scan is:</p><p><img src=https://user-images.githubusercontent.com/4021595/155911430-d2b7e904-6a8a-426c-bc27-e2167dd03a4d.png alt={DE1B0DF7-49B8-47F8-ACFF-B205F70BE58B}></p><ol start=2><li>Run QSM pipeline:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 /opt/QSMxT/run_2_qsm.py 01_bids 02_qsm_output
</span></span></code></pre></div></li></ol><p>Then you can open a viewer (Visualization -> mricrogl -> mricroglGUI) and you can find the QSM outputs in /neurodesktop-storage/qsmxt-demo/02_qsm_output/qsm_final/_run_run-1/</p><p>for example: sub-170705-134431-std-1312211075243167001_ses-1_run-1_part-phase_T2starw_scaled_qsm_000_composite_average.nii</p><p><img src=https://user-images.githubusercontent.com/4021595/155106388-72a691a4-c0a4-4cc6-a2ac-c9271888b82d.png alt=image></p><blockquote><p>Please note that the demo dataset does not have a T1w scan for anatomical segmentation and therefore the subsequent steps in QSMxT (e.g. <code>python3 /opt/QSMxT/run_3_segment.py 01_bids 03_segmentation</code>) will NOT work.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-3174433b4a44ad886176920795e9074f>2 - SWI</h1><div class=lead>Example workflow for SWI processing</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c fetch 01_bids.zip /neurodesktop-storage/swi-demo/01_bids.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/swi-demo/01_bids.zip -d /neurodesktop-storage/swi-demo/
</span></span></code></pre></div><p>Open the CLEARSWI tool from the application menu:</p><p>paste this julia script in a julia file and execute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>vi clearswi.jl
</span></span></code></pre></div><p>hit a or i and then paste this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>using CLEARSWI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TEs = [20] 
</span></span><span style=display:flex><span>nifti_folder = &#34;/neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat&#34;
</span></span><span style=display:flex><span>magfile = joinpath(nifti_folder, &#34;sub-170705134431std1312211075243167001_ses-1_acq-qsm_run-1_magnitude.nii.gz&#34;)
</span></span><span style=display:flex><span>phasefile = joinpath(nifti_folder, &#34;sub-170705134431std1312211075243167001_ses-1_acq-qsmPH00_run-1_phase.nii.gz&#34;) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mag = readmag(magfile);
</span></span><span style=display:flex><span>phase = readphase(phasefile);
</span></span><span style=display:flex><span>data = Data(mag, phase, mag.header, TEs);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>swi = calculateSWI(data);
</span></span><span style=display:flex><span># mip = createIntensityProjection(swi, minimum); # minimum intensity projection, other Julia functions can be used instead of minimum
</span></span><span style=display:flex><span>mip = createMIP(swi); # shorthand for createIntensityProjection(swi, minimum)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>savenii(swi, &#34;/neurodesktop-storage/swi-demo/swi.nii&#34;; header=mag.header) 
</span></span><span style=display:flex><span>savenii(mip, &#34;/neurodesktop-storage/swi-demo/mip.nii&#34;; header=mag.header)
</span></span></code></pre></div><p>hit SHIFT-Z-Z and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>julia clearswi.jl
</span></span></code></pre></div><p>Open ITK snap from the Visualization Application&rsquo;s menu and inspect the results (the outputs are in swi-demo/swi.nii and mip.nii)
<img src=https://user-images.githubusercontent.com/4021595/137708852-6b7dd2c7-3e6f-42fd-88e6-06afe87a72a9.png alt=image></p></div><div class=td-content style=page-break-before:always><h1 id=pg-359022268721811f542c4065f38891ed>3 - Unwrapping</h1><div class=lead>MRI Phase Unwrapping</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c fetch 01_bids.zip /neurodesktop-storage/swi-demo/01_bids.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/swi-demo/01_bids.zip -d /neurodesktop-storage/swi-demo/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /neurodesktop-storage/romeo-demo/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp /neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat/sub-170705134431std1312211075243167001_ses-1_acq-qsmPH00_run-1_phase.nii.gz /neurodesktop-storage/romeo-demo/phase.nii.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp /neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat/sub-170705134431std1312211075243167001_ses-1_acq-qsm_run-1_magnitude.nii.gz /neurodesktop-storage/romeo-demo/mag.nii.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gunzip /neurodesktop-storage/romeo-demo/mag.nii.gz
</span></span><span style=display:flex><span>gunzip /neurodesktop-storage/romeo-demo/phase.nii.gz
</span></span></code></pre></div><h3 id=using-romeo-for-phase-unwrapping>Using ROMEO for phase unwrapping</h3><p>Open the ROMEO tool from the application menu and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>romeo -p /neurodesktop-storage/romeo-demo/phase.nii -m /neurodesktop-storage/romeo-demo/mag.nii -k nomask -o /neurodesktop-storage/romeo-demo/
</span></span></code></pre></div><p><img src=/MRIPhase_Tutorial/romeo.PNG alt=Romeo title=Romeo></p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/neuro_desk aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dicussion Forum (requires github login)" aria-label="Dicussion Forum (requires github login)"><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk/neurodesk.github.io/discussions aria-label="Dicussion Forum (requires github login)"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/neurodesk.github.io/js/tabpane-persist.js></script>
<script src=/neurodesk.github.io/js/main.min.2b242016bd393aa86ff3b4500b2baae3b55d65f622435861b9338518eb4a5f69.js integrity="sha256-KyQgFr05Oqhv87RQCyuq47VdZfYiQ1hhuTOFGOtKX2k=" crossorigin=anonymous></script>
<script src=/neurodesk.github.io/js/prism.js></script></body></html>