<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.94.0"><link rel=canonical type=text/html href=https://www.neurodesk.org/tutorials/><link rel=alternate type=application/rss+xml href=https://www.neurodesk.org/tutorials/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Tutorials | NeuroDesk</title><meta name=description content="Tutorials
"><meta property="og:title" content="Tutorials"><meta property="og:description" content="Tutorials
"><meta property="og:type" content="website"><meta property="og:url" content="https://www.neurodesk.org/tutorials/"><meta property="og:site_name" content="NeuroDesk"><meta itemprop=name content="Tutorials"><meta itemprop=description content="Tutorials
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tutorials"><meta name=twitter:description content="Tutorials
"><link rel=preload href=/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css as=style><link href=/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-221108279-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">NeuroDesk</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/how-to-cite-us/><span>Cite</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/applications/><span>Applications</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/developers/><span>Developers</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/tutorials/><span class=active>Tutorials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/NeuroDesk target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://twitter.com/neuro_desk target=_blank><span>News</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.77f7ffe8422e40622719abb1623029d5.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/tutorials/>Return to the regular view of this page</a>.</p></div><h1 class=title>Tutorials</h1><div class=lead>Tutorials</div><ul><li>1: <a href=#pg-49ca1e3e5876541479c39ca4c2df0968>Electrophysiology</a></li><ul><li>1.1: <a href=#pg-3a19a2fed74591e4be7f94ab5ea8fd3d>Analysing M/EEG Data with FieldTrip</a></li><li>1.2: <a href=#pg-7212f82ad48dcf25da7a87aef4dbbdaf>Analysing EEG Data with MNE</a></li></ul><li>2: <a href=#pg-6e967e290a5f03717d740223a55e01ae>Functional Imaging</a></li><ul><li>2.1: <a href=#pg-dd982111decec7207955837c64096fcd>Using fmriprep with neurodesk on an HPC</a></li><li>2.2: <a href=#pg-ab10fff7c4446094d664d50ded4ff0b2>Using mriqc with neurodesk on HPC</a></li><li>2.3: <a href=#pg-8dfbf581aa47092d3c6ae308716ee073>PhysIO</a></li><li>2.4: <a href=#pg-81e7e4c62671608612946e451285df2b>A batch scripting example for PhysIO toolbox</a></li></ul><li>3: <a href=#pg-692ee0c0d1d645ba985513777e1a945e>MRI phase Processing</a></li><ul><li>3.1: <a href=#pg-ed3153aa84e753252b1a096df3880cc5>Quantitative Susceptibility Mapping</a></li><li>3.2: <a href=#pg-3174433b4a44ad886176920795e9074f>SWI</a></li><li>3.3: <a href=#pg-359022268721811f542c4065f38891ed>Unwrapping</a></li></ul><li>4: <a href=#pg-e73d6e2f298a289114c630abc2e19e86>Reproducibility</a></li><ul><li>4.1: <a href=#pg-8a2da6b2ab26a553c2fb81d5245ed391>Reproducible script execution with DataLad</a></li></ul><li>5: <a href=#pg-8c40c307d7ecba12d00ebe818ffe3d8e>Spectroscopy</a></li><ul><li>5.1: <a href=#pg-760d47cbb109546f814f11be568e5a05>Spectroscopy with lcmodel</a></li></ul><li>6: <a href=#pg-15c972db4ef066d5b196709a32931050>Structural Imaging</a></li><ul><li>6.1: <a href=#pg-0fe48d9b685f097a75026e660a1fae15>FreeSurfer</a></li><li>6.2: <a href=#pg-8f91ba533395ac388eb6713e856ce144>Structural connectivity dMRI</a></li></ul><li>7: <a href=#pg-9d3542de6d1d1b0ffa46b2886fe35344>Documentation</a></li><ul><li>7.1: <a href=#pg-b0590b6e45cbf130ebe8a6b8b8677519>Template for workflow creation</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-49ca1e3e5876541479c39ca4c2df0968>1 - Electrophysiology</h1><div class=lead>Tutorials about processing of EEG/MEG/ECoG data</div></div><div class=td-content><h1 id=pg-3a19a2fed74591e4be7f94ab5ea8fd3d>1.1 - Analysing M/EEG Data with FieldTrip</h1><div class=lead>A brief guide to using FieldTrip to analyse electrophysiological data within neurodesk.</div><blockquote><p><em>This tutorial was created by Judy D Zhu.</em></p><p>Email: <a href=mailto:judyzhud@gmail.com>judyzhud@gmail.com</a></p><p>Github: @JD-Zhu</p><p>Twitter: @JudyDZhu</p></blockquote><hr><p>Please note that this container uses a compiled version of FieldTrip to run scripts (without needing a Matlab license). Code development is not currently supported within the container and needs to be carried out separatedly in Matlab.<br><br></p><h2 id=getting-started>Getting started</h2><ol><li>Navigate to Neurodesk->Electrophysiology->fieldtrip->fieldtrip20211114 in the menu:</li></ol><p><img src=/fieldtrip/1_menu.png alt=1_menu title=1_menu></p><p>Once this window is loaded, you are ready to go:</p><p><img src=/fieldtrip/2_container.PNG alt=2_container title=2_container></p><br><ol start=2><li>Type the following into the command window (replacing &ldquo;yourscript.m&rdquo; with the name of your custom script - note that you may also need to supply the full path):</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>run_fieldtrip.sh /opt/MCR/v99 yourscript.m
</span></span></code></pre></div><p>For example, here we ran a script to browse some raw data:</p><p><img src=/fieldtrip/3_running.PNG alt=3_running title=3_running></p><p>The fieldtrip GUI is displayed automatically and functions as it normally would when running inside Matlab.</p><p>NOTES:</p><ol><li>The script specified in the command line can call other scripts</li><li>The script and the scripts it calls can use all the MATLAB toolboxes included in the compiled version of FieldTrip. If additional MATLAB toolboxes are needed, they need to be put in a filesystem accessible to the FieldTrip container (/neurodesktop-storage, /home/user, etc.), and the path should be added to the MATLAB search path with the addpath function (<a href=https://www.mathworks.com/help/matlab/ref/addpath.html>https://www.mathworks.com/help/matlab/ref/addpath.html</a>)</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-7212f82ad48dcf25da7a87aef4dbbdaf>1.2 - Analysing EEG Data with MNE</h1><div class=lead>Use mne-python to load, pre-process, and plot example EEG data in a jupyter notebook through vscode.</div><h2 id=getting-started>Getting started</h2><p>To begin, navigate to Neurodesk->Electrophysiology->mne->vscodeGUI 0.23.4 in the menu. This version of vscode has been installed in a software container together with the a conda environment containing MNE-python. Note that if you open any other version of vscode in Neurodesk, you will not be able to access the MNE conda environment.</p><p><img src=/EEG_Tutorial/EEGtut0.png alt=EEGtut0 title=EEGtut0></p><p><img src=/EEG_Tutorial/EEGtut1.png alt=EEGtut1 title=EEGtut1></p><p>Open the folder: “/home/user/Desktop/storage” or a subfolder in which you would like to store this demo. In this folder, create a new file named “EEGDemo.ipynb” or something similar:</p><p><img src=/EEG_Tutorial/EEGtut2.png alt=EEGtut2 title=EEGtut2></p><p>If this is your first time opening a Jupyter notebook on vscode in neurodesktop, you may see the following popup. If so, click “install” to install the vscode extensions for Jupyter.</p><p><img src=/EEG_Tutorial/EEGtut3.png alt=EEGtut3 title=EEGtut3></p><h2 id=select-mne-python-kernel>Select MNE python kernel</h2><p>Next, we need to direct vscode to use the python kernel associated with MNE. In the top right corner of your empty jupyter notebook, click “Select Kernel”:</p><p><img src=/EEG_Tutorial/EEGtut4.png alt=EEGtut4 title=EEGtut4></p><p>Then, select mne-0.23.4 from the dropdown menu, which should look something like this:</p><p><img src=/EEG_Tutorial/EEGtut5.png alt=EEGtut5 title=EEGtut5></p><h2 id=activate-the-mne-conda-environment-in-the-terminal>Activate the MNE conda environment in the terminal</h2><p>Next, we&rsquo;ll activate the same MNE environment in a terminal. From the top menu in vscode, select Terminal->New Terminal, or hit [Ctrl]+[Shift]+[`].</p><p>If this is your first time using vscode in this container, you may have to initialise conda by typing <code>conda init bash</code> in the bash terminal. After initialising bash, you will have to close and then reopen the terminal.</p><p>Once you have initialised conda, you can activate the MNE environment in the terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>conda activate mne-0.23.4
</span></span></code></pre></div><p>You should now see &ldquo;(mne-0.23.4)&rdquo; ahead of the current line in the terminal.</p><h2 id=download-sample-data>Download sample data</h2><p>In the terminal (in which you have activated the MNE environment), input the following code to download some BIDS formatted sample EEG data:</p><blockquote><p>Remember to update the path to the location you are storing this tutorial!</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>osf -p C689U fetch Data_sample.zip /neurodesktop-storage/EEGDEMO/Data_sample.zip
</span></span><span style=display:flex><span>unzip Data_sample.zip 
</span></span></code></pre></div><p>This is a small dataset with only 5 EEG channels from a single participant. The participant is viewing a frequency tagged display and is cued to attend to dots tagged at one frequency or another (6 Hz, 7.5 Hz) for long, 15 s trials. To read more about the dataset, click <a href=https://osf.io/c689u/>here</a></p><h2 id=plotting-settings>Plotting settings</h2><p>To make sure our plots retain their interactivity, set the following line at the top of your notebook:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>%matplotlib qt
</span></span></code></pre></div><p>This will mean your figures pop out as individual, interactive plots that will allow you to explore the data, rather than as static, inline plots. You can switch “qt” to “inline” to switch back to default, inline plotting.</p><h2 id=loading-and-processing-data>Loading and processing data</h2><blockquote><p>NOTE: MNE has many helpful tutorials which delve into data processing and analysis using MNE-python in much further detail. These can be found <a href=https://mne.tools/stable/auto_tutorials/index.html>here</a></p></blockquote><p>Begin by importing the necessary modules and creating a pointer to the data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Interactive plotting
</span></span><span style=display:flex><span>%matplotlib qt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Import modules
</span></span><span style=display:flex><span>import os
</span></span><span style=display:flex><span>import numpy as np
</span></span><span style=display:flex><span>import mne
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Load data
</span></span><span style=display:flex><span>sample_data_folder = &#39;/neurodesktop-storage/EEGDemo/Data_sample&#39;
</span></span><span style=display:flex><span>sample_data_raw_file = os.path.join(sample_data_folder, &#39;sub-01&#39;, &#39;eeg&#39;,
</span></span><span style=display:flex><span>                                    &#39;sub-01_task-FeatAttnDec_eeg.vhdr&#39;)
</span></span><span style=display:flex><span>raw = mne.io.read_raw_brainvision(sample_data_raw_file , preload=True)
</span></span></code></pre></div><p>the raw.info structure contains information about the dataset:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Display data info
</span></span><span style=display:flex><span>print(raw)
</span></span><span style=display:flex><span>print(raw.info)
</span></span></code></pre></div><p>This data file did not include a montage. Lets create one using standard values for the electrodes we have:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Create montage
</span></span><span style=display:flex><span>montage = {&#39;Iz&#39;:  [0, -110, -40],
</span></span><span style=display:flex><span>            &#39;Oz&#39;: [0, -105, -15],
</span></span><span style=display:flex><span>            &#39;POz&#39;: [0,   -100, 15],
</span></span><span style=display:flex><span>            &#39;O1&#39;: [-40, -106, -15],
</span></span><span style=display:flex><span>            &#39;O2&#39;:  [40, -106, -15],
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>montageuse = mne.channels.make_dig_montage(ch_pos=montage, lpa=[-82.5, -19.2, -46], nasion=[0, 83.2, -38.3], rpa=[82.2, -19.2, -46]) # based on mne help file on setting 10-20 montage
</span></span></code></pre></div><p>Next, lets visualise the data.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>raw.plot()
</span></span></code></pre></div><p>This should open an interactive window in which you can scroll through the data. See the MNE documentation for help on how to customise this plot.</p><p><img src=/EEG_Tutorial/EEGtut6.png alt=EEGtut6 title=EEGtut6></p><p>If, upon visual inspection, you decide to exclude one of the channels, you can specify this in raw.info[‘bads’] now. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>raw.info[&#39;bads&#39;] = [&#39;POz&#39;]
</span></span></code></pre></div><p>Next, we’ll extract our events. The trigger channel in this file is incorrectly scaled, so we’ll correct that before we extract our events:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Correct trigger scaling
</span></span><span style=display:flex><span>trigchan = raw.copy()
</span></span><span style=display:flex><span>trigchan = trigchan.pick(&#39;TRIG&#39;)
</span></span><span style=display:flex><span>trigchan._data = trigchan._data*1000000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Extract events
</span></span><span style=display:flex><span>events = mne.find_events(trigchan, stim_channel=&#39;TRIG&#39;, consecutive=True, initial_event=True, verbose=True)
</span></span><span style=display:flex><span>print(&#39;Found %s events, first five:&#39; % len(events))
</span></span><span style=display:flex><span>print(events[:5])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Plot events
</span></span><span style=display:flex><span>mne.viz.plot_events(events, raw.info[&#39;sfreq&#39;], raw.first_samp)
</span></span></code></pre></div><p><img src=/EEG_Tutorial/EEGtut7.png alt=EEGtut7 title=EEGtut7></p><p>Now that we’ve extracted our events, we can extract our EEG channels and do some simple pre-processing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># select
</span></span><span style=display:flex><span>eeg_data = raw.copy().pick_types(eeg=True, exclude=[&#39;TRIG&#39;])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Set montage
</span></span><span style=display:flex><span>eeg_data.info.set_montage(montageuse)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Interpolate
</span></span><span style=display:flex><span>eeg_data_interp = eeg_data.copy().interpolate_bads(reset_bads=True) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Filter Data
</span></span><span style=display:flex><span>eeg_data_interp.filter(l_freq=1, h_freq=45, h_trans_bandwidth=0.1)
</span></span></code></pre></div><p>Let’s visualise our data again now that it’s cleaner:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#plot results again, this time with some events and scaling. 
</span></span><span style=display:flex><span>eeg_data_interp.plot(events=events, duration=10.0, scalings=dict(eeg=0.00005), color=&#39;k&#39;, event_color=&#39;r&#39;)
</span></span></code></pre></div><p><img src=/EEG_Tutorial/EEGtut8.png alt=EEGtut8 title=EEGtut8></p><p>That’s looking good! We can even see hints of the frequency tagging. It’s about time to epoch our data.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Epoch to events of interest
</span></span><span style=display:flex><span>event_id = {&#39;attend 6Hz K&#39;: 23, &#39;attend 7.5Hz K&#39;:  27}  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Extract 15 s epochs relative to events, baseline correct, linear detrend, and reject 
</span></span><span style=display:flex><span># epochs where eeg amplitude is &gt; 400
</span></span><span style=display:flex><span>epochs = mne.Epochs(eeg_data_interp, events, event_id=event_id, tmin=0,
</span></span><span style=display:flex><span>                    tmax=15, baseline=(0, 0), reject=dict(eeg=0.000400), detrend=1)  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Drop bad trials
</span></span><span style=display:flex><span>epochs.drop_bad()
</span></span></code></pre></div><p>We can average these epochs to form Event Related Potentials (ERPs):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Average erpochs to form ERPs
</span></span><span style=display:flex><span>attend6 = epochs[&#39;attend 6Hz K&#39;].average()
</span></span><span style=display:flex><span>attend75 = epochs[&#39;attend 7.5Hz K&#39;].average()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Plot ERPs
</span></span><span style=display:flex><span>evokeds = dict(attend6=list(epochs[&#39;attend 6Hz K&#39;].iter_evoked()),
</span></span><span style=display:flex><span>               attend75=list(epochs[&#39;attend 7.5Hz K&#39;].iter_evoked()))
</span></span><span style=display:flex><span>mne.viz.plot_compare_evokeds(evokeds, combine=&#39;mean&#39;)
</span></span></code></pre></div><p><img src=/EEG_Tutorial/EEGtut9.png alt=EEGtut9 title=EEGtut9></p><p>In this plot, we can see that the data are frequency tagged. While these data were collected, the participant was performing an attention task in which two visual stimuli were flickering at 6 Hz and 7.5 Hz respectively. On each trial the participant was cued to monitor one of these two stimuli for brief bursts of motion. From previous research, we expect that the steady-state visual evoked potential (SSVEP) should be larger at the attended frequency than the unattended frequency. Lets check if this is true.</p><p>We&rsquo;ll begin by exporting our epoched EEG data to a numpy array</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Preallocate
</span></span><span style=display:flex><span>n_samples = attend6.data.shape[1]
</span></span><span style=display:flex><span>sampling_freq = 1200 # sampling frequency
</span></span><span style=display:flex><span>epochs_np = np.empty((n_samples, 2) )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Get data - averaging across EEG channels
</span></span><span style=display:flex><span>epochs_np[:,0] = attend6.data.mean(axis=0)
</span></span><span style=display:flex><span>epochs_np[:,1] = attend75.data.mean(axis=0)
</span></span></code></pre></div><p>Next, we can use a Fast Fourier Transform (FFT) to transform the data from the time domain to the frequency domain. For this, we&rsquo;ll need to import the FFT packages from scipy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>from scipy.fft import fft, fftfreq, fftshift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Get FFT
</span></span><span style=display:flex><span>fftdat = np.abs(fft(epochs_np, axis=0)) / n_samples
</span></span><span style=display:flex><span>freq = fftfreq(n_samples, d=1 / sampling_freq)  # get frequency bins
</span></span></code></pre></div><p>Now that we have our frequency transformed data, we can plot our two conditions to assess whether attention altered the SSVEP amplitudes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import matplotlib.pyplot as plt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fig,ax = plt.subplots(1, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax.plot(freq, fftdat[:,0], &#39;-&#39;, label=&#39;attend 6Hz&#39;, color=[78 / 255, 185 / 255, 159 / 255])  
</span></span><span style=display:flex><span>ax.plot(freq, fftdat[:,1], &#39;-&#39;, label=&#39;attend 7.5Hz&#39;, color=[236 / 255, 85 / 255, 58 / 255])  
</span></span><span style=display:flex><span>ax.set_xlim(4, 17)
</span></span><span style=display:flex><span>ax.set_ylim(0, 1e-6)
</span></span><span style=display:flex><span>ax.set_title(&#39;Frequency Spectrum&#39;)
</span></span><span style=display:flex><span>ax.legend()
</span></span></code></pre></div><p><img src=/EEG_Tutorial/EEGtut10.PNG alt=EEGtut10 title=EEGtut10></p><p>This plot shows that the SSVEPs were indeed modulated by attention in the direction we would expect! Congratulations! You’ve run your first analysis of EEG data in neurodesktop.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6e967e290a5f03717d740223a55e01ae>2 - Functional Imaging</h1><div class=lead>Tutorials about processing functional MRI data</div></div><div class=td-content><h1 id=pg-dd982111decec7207955837c64096fcd>2.1 - Using fmriprep with neurodesk on an HPC</h1><div class=lead>A brief guide to using fmriprep with neurodesk, using data from the STRIAVISE project.</div><blockquote><p><em>This tutorial was created by Kelly G. Garner.</em></p><p>Github: <a href=https://github.com/kel-github>@kel_github</a></p><p>Twitter: <a href=https://twitter.com/garner_theory>@garnertheory</a></p></blockquote><blockquote><p>This workflow documents how to use fmriprep with neurodesk and provides some details that may help you troubleshoot some common problems I found along the way.</p></blockquote><hr><h1 id=assumptions>Assumptions</h1><ul><li><input disabled type=checkbox> Your data is already in BIDS format</li><li><input disabled type=checkbox> You plan to run fmriprep using Neurodesk</li><li><input disabled type=checkbox> You have a local copy of the freesurfer license file (freesurfer.txt)</li></ul><hr><h1 id=steps>Steps</h1><h2 id=open-fmriprep>Open fmriprep</h2><p>From the applications go Neurodesk -> Functional Imaging -> fmriprep and select the latest version of fmriprep. This should take you to a terminal window with fmriprep loaded.</p><h2 id=setting-up-fmriprep-command>Setting up fmriprep command</h2><p>If you like, you can enter the following fmriprep command straight into the command line in the newly opened terminal. However, as with increasing options and preferences the command can get rather verbose, I instead opted to create an executable bash script that I can run straight from the command line, with minimal editing inbetween runs. If you&rsquo;re not interested in this option you can skip straight to copying/adjusting the code from <code>fmriprep</code> to <code>-v</code> below.</p><ul><li>open a new file in your editor of choice but really you know it should be Visual Studio Code</li><li>save that file with your chosen name without an extension, e.g. run_fmriprep</li><li>paste in the following and update with your details</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># written by A. Name - the purpose of this code is to run fmriprep with neurodesk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span> <span style=color:#8f5902;font-style:italic># specify the number of threads you want to use</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fmriprep /path/to/your/data <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># this is the top level of your data folder</span>
</span></span><span style=display:flex><span>         /path/to/your/data/derivatives <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># where you want fmriprep output to be saved</span>
</span></span><span style=display:flex><span>         participant <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># this tells fmriprep to analyse at the participant level</span>
</span></span><span style=display:flex><span>         --fs-license-file /path/to/your/freesurfer.txt <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># where the freesurfer license file is</span>
</span></span><span style=display:flex><span>         --output-spaces T1w MNI152NLin2009cAsym fsaverage fsnative <span style=color:#4e9a06>\ </span>
</span></span><span style=display:flex><span>         --participant-label <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># put what ever participant labels you want to analyse</span>
</span></span><span style=display:flex><span>         --nprocs <span style=color:#0000cf;font-weight:700>6</span> --mem <span style=color:#0000cf;font-weight:700>10000</span> <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># fmriprep can be greedy on the hpc, make sure it is not</span>
</span></span><span style=display:flex><span>         --skip_bids_validation <span style=color:#4e9a06>\ </span><span style=color:#8f5902;font-style:italic># its normally fine to skip this but do make sure your data are BIDS enough</span>
</span></span><span style=display:flex><span>         -v <span style=color:#8f5902;font-style:italic># be verbal fmriprep, tell me what you are doing</span>
</span></span></code></pre></div><p>To make the file executable, navigate to this file via the command line in terminal and type</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod u+x run_fmriprep <span style=color:#8f5902;font-style:italic># this tells the system to make your new file executable</span>
</span></span></code></pre></div><p>Then to run your new executable, return to your terminal window for fmriprep (that opened when you navigated to fmriprep) and type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./run_fmriprep
</span></span></code></pre></div><p>fmriprep should now be merrily working away on your data :)</p><hr><h2 id=some-common-pitfalls-i-have-learned-from-my-mistakes-and-sometimes-from-others>Some common pitfalls I have learned from my mistakes (and sometimes from others)</h2><ol><li><p>If fmriprep hangs it could well be that you are out of disk space. Sometimes this is because fmriprep created a work directory in your home folder which is often limited on the HPC. Make sure fmriprep knows to use a work drectory in your scratch. you can specify this in the fmriprep command by using -w /path/to/the/work/directory/you/made</p></li><li><p>I learned this from TomCat (@thomshaw92) - fmriprep can get confused between subjects when run in parallel. Parallelise with caution.</p></li><li><p>If running on a HPC, make sure to set the processor and memory limits, if not your job will get killed because it hogs all the resources.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ab10fff7c4446094d664d50ded4ff0b2>2.2 - Using mriqc with neurodesk on HPC</h1><div class=lead>A brief guide to using mriqc with neurodesk, using data from the STRIAVISE project.</div><blockquote><p><em>This tutorial was created by Kelly G. Garner.</em></p><p>Github: <a href=https://github.com/kel-github>@kel_github</a></p><p>Twitter: <a href=https://twitter.com/garner_theory>@garnertheory</a></p></blockquote><blockquote><p>This workflow documents how to use mriqc with neurodesk and provides some details that may help you troubleshoot some common problems I found along the way.</p></blockquote><hr><h1 id=assumptions>Assumptions</h1><ul><li><input disabled type=checkbox> Your data is already in BIDS format</li><li><input disabled type=checkbox> You plan to run mriqc using Neurodesk</li></ul><hr><h1 id=steps>Steps</h1><h2 id=open-mriqc>Open mriqc</h2><p>From the applications go Neurodesk -> Functional Imaging -> mriqc and select the latest version of mriqc. This should take you to a terminal window with mriqc loaded.<p></p><p><img src=/mriqc_cvl/mriqc_terminal.png alt=mriqc_terminal title=mriqc_terminal> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><h2 id=setting-up-mriqc-command>Setting up mriqc command</h2><p>If you like, you can enter the following mriqc commands straight into the command line in the newly opened terminal. However, as with increasing options and preferences the command can get rather verbose, so I instead opted to create executable bash scripts that I can run straight from the command line, with minimal editing inbetween runs. I made one for running mriqc at the participant level, and one for running at the group level (for the group report, once all the participants are done). If you&rsquo;re not interested in this option you can skip straight to copying/adjusting the code from <code>mriqc</code> to <code>-v</code> below.</p><ul><li>open a new file in your editor of choice (e.g. Visual Studio Code)</li><li>save that file with your chosen name without an extension, e.g. run_mriqc_participant or run_mriqc_group</li><li>paste in the following and update with your details</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a40000>#</span><span style=color:#000;font-weight:700>!</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bin</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bash</span>
</span></span><span style=display:flex><span><span style=color:#a40000>#</span>
</span></span><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>written</span> <span style=color:#000>by</span> <span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span> <span style=color:#000>Name</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>the</span> <span style=color:#000>purpose</span> <span style=color:#000>of</span> <span style=color:#000>this</span> <span style=color:#000>code</span> <span style=color:#000>is</span> <span style=color:#000>to</span> <span style=color:#000>run</span> <span style=color:#000>mriqc</span> <span style=color:#000>with</span> <span style=color:#000>neurodesk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>export</span> <span style=color:#000>ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span> <span style=color:#a40000>#</span> <span style=color:#000>specify</span> <span style=color:#000>the</span> <span style=color:#000>number</span> <span style=color:#000>of</span> <span style=color:#000>threads</span> <span style=color:#000>you</span> <span style=color:#000>want</span> <span style=color:#000>to</span> <span style=color:#000>use</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>mriqc</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>your</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>data</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span> <span style=color:#000>this</span> <span style=color:#000>is</span> <span style=color:#000>the</span> <span style=color:#000>top</span> <span style=color:#000>level</span> <span style=color:#000>of</span> <span style=color:#000>your</span> <span style=color:#000>data</span> <span style=color:#000>folder</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>your</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>derivatives</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span> <span style=color:#000>where</span> <span style=color:#000>you</span> <span style=color:#000>want</span> <span style=color:#000>mriqc</span> <span style=color:#000>output</span> <span style=color:#000>to</span> <span style=color:#000>be</span> <span style=color:#000>saved</span>
</span></span><span style=display:flex><span>         <span style=color:#000>participant</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span> <span style=color:#000>this</span> <span style=color:#000>tells</span> <span style=color:#000>mriqc</span> <span style=color:#000>to</span> <span style=color:#000>analyse</span> <span style=color:#000>at</span> <span style=color:#000>the</span> <span style=color:#000>participant</span> <span style=color:#000>level</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>participant</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>label</span> <span style=color:#0000cf;font-weight:700>01</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span> <span style=color:#000>put</span> <span style=color:#000>what</span> <span style=color:#000>ever</span> <span style=color:#000>participant</span> <span style=color:#000>labels</span> <span style=color:#000>you</span> <span style=color:#000>want</span> <span style=color:#000>to</span> <span style=color:#000>analyse</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>directory</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span><span style=color:#000>useful</span> <span style=color:#000>to</span> <span style=color:#000>specify</span> <span style=color:#000>so</span> <span style=color:#000>your</span> <span style=color:#000>home</span> <span style=color:#000>directory</span> <span style=color:#000>definitely</span> <span style=color:#000>doesnt</span> <span style=color:#000>get</span> <span style=color:#000>clogged</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>nprocs</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>mem_gb</span> <span style=color:#0000cf;font-weight:700>10000</span> <span style=color:#a40000>\</span> <span style=color:#a40000>#</span> <span style=color:#000>mriqc</span> <span style=color:#000>can</span> <span style=color:#000>be</span> <span style=color:#000>greedy</span> <span style=color:#000>on</span> <span style=color:#000>the</span> <span style=color:#000>hpc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>make</span> <span style=color:#000>sure</span> <span style=color:#000>it</span> <span style=color:#000>is</span> <span style=color:#000>not</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>v</span> <span style=color:#a40000>#</span> <span style=color:#000>be</span> <span style=color:#000>verbal</span> <span style=color:#000>mriqc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tell</span> <span style=color:#000>me</span> <span style=color:#000>what</span> <span style=color:#000>you</span> <span style=color:#000>are</span> <span style=color:#000>doing</span>
</span></span></code></pre></div><p>OR: if you have run all the participants and you just want the group level report, use these mriqc commands instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mriqc /path/to/your/data \ # this is the top level of your data folder
</span></span><span style=display:flex><span>         /path/to/your/data/derivatives \ # where you want mriqc output to be saved. As you are running the group level analysis this folder should be prepopulated with the results of the participant level analysis
</span></span><span style=display:flex><span>         group \ # this tells mriqc to agive you the group report
</span></span><span style=display:flex><span>         -w /path/to/work/directory \ #useful to specify so your home directory definitely doesnt get clogged
</span></span><span style=display:flex><span>         --nprocs 6 --mem_gb 10000 \ # mriqc can be greedy on the hpc, make sure it is not
</span></span><span style=display:flex><span>         -v # be verbal mriqc, tell me what you are doing
</span></span></code></pre></div><p>To make either of yours files executable, navigate via the terminal to the same folder in which this file is saved. If you list the files in the folder by using the command <code>ls</code> you should see your file with the name printed in white.</p><p><img src=/mriqc_cvl/pre_exec.png alt=pre_exec title=pre_exec> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><p>Now type the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>chmod</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>x</span> <span style=color:#000>run_mriqc_participant</span> <span style=color:#a40000>#</span> <span style=color:#000>this</span> <span style=color:#000>tells</span> <span style=color:#000>the</span> <span style=color:#000>system</span> <span style=color:#000>to</span> <span style=color:#000>make</span> <span style=color:#000>your</span> <span style=color:#000>new</span> <span style=color:#000>file</span> <span style=color:#000>executable</span>
</span></span></code></pre></div><p>To know this worked, list the files again. If you have successfully made your file executable then it will be listed in green.</p><p><img src=/mriqc_cvl/mriqc_post_exec.png alt=mriqc_post_exec title=mriqc_post_exec> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><p>Then to run your new executable, return to your terminal window for mriqc (that opened when you navigated to mriqc), navigate to the directory where your executable file is stored and type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>name_of_your_mriqc_file</span>
</span></span></code></pre></div><p>mriqc should now be merrily working away on your data :)</p><hr><h2 id=some-common-pitfalls-i-have-learned-from-my-mistakes-and-sometimes-from-others>Some common pitfalls I have learned from my mistakes (and sometimes from others)</h2><ol><li>If running on a HPC, make sure to set the processor and memory limits, if not your job will get killed because mriqc hogs all the resources.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-8dfbf581aa47092d3c6ae308716ee073>2.3 - PhysIO</h1><div class=lead>Example workflow for the PhysIO Toolbox</div><blockquote><p><em>This tutorial was created by Lars Kasper.</em></p><p>Github: @mrikasper</p><p>Twitter: @mrikasper</p></blockquote><h2 id=origin>Origin</h2><p>The PhysIO Toolbox implements ideas for robust physiological noise modeling in fMRI, outlined in this paper:</p><ol><li>Kasper, L., Bollmann, S., Diaconescu, A.O., Hutton, C., Heinzle, J., Iglesias,
S., Hauser, T.U., Sebold, M., Manjaly, Z.-M., Pruessmann, K.P., Stephan, K.E., 2017.
<em>The PhysIO Toolbox for Modeling Physiological Noise in fMRI Data</em>.
Journal of Neuroscience Methods 276, 56-72. <a href=https://doi.org/10.1016/j.jneumeth.2016.10.019>https://doi.org/10.1016/j.jneumeth.2016.10.019</a></li></ol><p>PhysIO is part of the open-source <a href=https://translationalneuromodeling.github.io/tapas/>TAPAS Software Package</a> for Translational Neuromodeling and Computational Psychiatry, introduced in the following paper:</p><ol start=2><li>Frässle, S., Aponte, E.A., Bollmann, S., Brodersen, K.H., Do, C.T., Harrison, O.K., Harrison, S.J., Heinzle, J., Iglesias, S., Kasper, L., Lomakina, E.I., Mathys, C., Müller-Schrader, M., Pereira, I., Petzschner, F.H., Raman, S., Schöbi, D., Toussaint, B., Weber, L.A., Yao, Y., Stephan, K.E., 2021. <em>TAPAS: an open-source software package for Translational Neuromodeling and Computational Psychiatry</em>. Frontiers in Psychiatry 12, 857. <a href=https://doi.org/10.3389/fpsyt.2021.680811>https://doi.org/10.3389/fpsyt.2021.680811</a></li></ol><p>Please cite these works if you use PhysIO and see the <a href=https://gitlab.ethz.ch/physio/physio-doc/-/wikis/FAQ#3-how-do-i-cite-physio>FAQ</a> for details.</p><p>NeuroDesk offers the possibility of running PhysIO without installing Matlab or requiring a Matlab license. The functionality should be equivalent, though debugging and extending the toolbox, as well as unreleased development features, will only be available in the Matlab version of PhysIO, which is exlusively hosted on the <a href=https://github.com/translationalneuromodeling/tapas>TAPAS GitHub</a>.</p><p>More general info about PhysIO besides NeuroDesk usage is found in the <a href=https://github.com/translationalneuromodeling/tapas/tree/master/PhysIO#readme>README</a> on GitHub.</p><h2 id=purpose>Purpose</h2><p>The general purpose of the PhysIO toolbox is model-based physiological noise correction of fMRI data using peripheral measures of respiration and cardiac pulsation (respiratory bellows, ECG, pulse oximeter/plethysmograph).</p><p>It incorporates noise models of</p><ul><li>cardiac/respiratory phase (RETROICOR, Glover et al. 2000), as well as</li><li>heart rate variability and respiratory volume per time (cardiac response function, Chang et. al, 2009, respiratory response function, Birn et al. 2006),</li><li>and extended motion models (e.g., censoring/scrubbing)</li></ul><p>While the toolbox is particularly well integrated with SPM via the Batch Editor GUI, its output text files can be incorporated into any major neuroimaging analysis package for nuisance regression, e.g., within a GLM.</p><p>Core design goals for the toolbox were: flexibility, robustness, and quality assurance to enable physiological noise correction for large-scale and multi-center studies.</p><p>Some highlights:</p><ul><li>Robust automatic preprocessing of peripheral recordings via iterative peak detection, validated in noisy data and patients, and extended processing of respiratory data (Harrison et al., 2021)</li><li>Flexible support of peripheral data formats (BIDS, Siemens, Philips, GE, BioPac, HCP, &mldr;) and noise models (RETROICOR, RVHRCOR).</li><li>Fully automated noise correction and performance assessment for group studies.</li><li>Integration in fMRI pre-processing pipelines as SPM Toolbox (Batch Editor GUI).</li></ul><p>The accompanying technical paper about the toolbox concept and methodology can be found at: <a href=https://doi.org/10.1016/j.jneumeth.2016.10.019>https://doi.org/10.1016/j.jneumeth.2016.10.019</a></p><h2 id=download-example-data>Download Example Data</h2><p>The example data should already be present in NeuroDesk in the following folder <code>/opt/spm12</code></p><p>If you cannot find the example data there:</p><ol><li>Download the latest version from the <a href=https://github.com/translationalneuromodeling/tapas/blob/master/misc/log_tapas.txt>location mentioned in the TAPAS distribution</a><ul><li>e.g., <a href=https://www.tapas.tnu-zurich.com/examples_v5.0.0.zip>https://www.tapas.tnu-zurich.com/examples_v5.0.0.zip</a></li></ul></li><li>Follow the instructions for copying your own data in the next section</li></ol><h2 id=copy-your-own-data>Copy your own data</h2><ul><li>On Windows, the folder <code>C:\neurodesktop-storage</code> should have been automatically created when starting NeuroDesk</li><li>This is your direct link to the NeuroDesk environment, and anything you put in there should end up within the NeuroDesk desktop in <code>/neurodesktop-storage/</code> and on your desktop under <code>storage</code></li></ul><h2 id=example-running-physio-in-the-gui>Example: Running PhysIO in the GUI</h2><ol><li>Open the PhysIO GUI (Neurodesk -> Functional Imaging -> physio -> physioGUI r7771, see screenshot:</li></ol><p><img src=/FunctionalImaging_Tutorial/physio_screenshot1.jpg alt="PhysIO GUI in NeuroDesk" title=physio_screenshot></p><ol start=2><li>SPM should automatically open up (might take a while). Select &lsquo;fMRI&rsquo; from the modality selection screen.</li><li>Press the &ldquo;Batch Editor&rdquo; button (see screenshot with open Batch Editor, red highlights)</li></ol><p><img src=/FunctionalImaging_Tutorial/physio_screenshot2.jpg alt="NeuroDesk with SPM Batch Editor PhysIO" title=physio_screenshot2></p><pre><code>- NB: If you later want to create a new PhysIO batch with all parameters, from scratch or explore the options, select from the Batch Editor Menu top row, SPM -&gt; Tools -&gt; TAPAS PhysIO Toolbox (see screenshot, read highlights)
</code></pre><ol start=4><li>For now, load an existing example (or previously created SPM Batch File) as follows: It is most convenient to change the working directory of SPM to the location of the physiological logfiles<ul><li>In the Batch Editor GUI, lowest row, choose &lsquo;CD&rsquo; from the &lsquo;Utils..&rsquo; dropdown menu</li><li>Navigate to any of the example folders, e.g., <code>/opt/spm12/examples/Philips/ECG3T/</code> and select it</li><li>NB: you can skip this part, if you later manually update all input files in the Batch Editor window (resp/cardiac/scan timing and realignment parameter file further down)</li><li>Any other example should also work the same way, just CD to its folder before the next step</li></ul></li><li>Select File -> Load Batch from the top row menu of the Batch Editor window<ul><li>make sure you select the matlab batch file <code>*_spm_job.&lt;m|mat></code>, (e.g., <code>philips_ecg3t_spm_job.m</code> and <code>philips_ecg3t_spm_job.mat</code> are identical, either is fine), but not the script.</li></ul></li><li>Press The green &ldquo;Play&rdquo; button in the top icon menu row of the Batch Editor Window</li><li>Several output figures should appear, with the last being a grayscale plot of the nuisance regressor design matrix</li></ol><p><img src=/FunctionalImaging_Tutorial/physio_screenshot3.jpg alt="Output Nuisance Regressor Matrix PhysIO" title=physio_screenshot3></p><ol start=8><li>Congratulations, your first successful physiological noise model has been created! If you don&rsquo;t see the mentioned figure, chances are certain input files were not found (e.g., wrong file location specified). You can always check the text output in the &ldquo;bash&rdquo; window associated with the SPM window for any error messages.</li></ol><h2 id=further-info-on-physio>Further Info on PhysIO</h2><p>Please check out the <a href=https://github.com/translationalneuromodeling/tapas/tree/master/PhysIO#readme>README</a> and <a href=https://gitlab.ethz.ch/physio/physio-doc/-/wikis/FAQ>FAQ</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-81e7e4c62671608612946e451285df2b>2.4 - A batch scripting example for PhysIO toolbox</h1><div class=lead>Follow this tutorial as an example of how to batch script for the PhysIO toolbox using Neurodesk.</div><blockquote><p><em>This tutorial was created by Kelly G. Garner.</em></p><p>Github: @kel-github</p><p>Twitter: @garner_theory</p></blockquote><p>This tutorial walks through 1 way to batch script the use of the PhysIO toolbox with Neurodesk.
The goal is to use the toolbox to generate physiological regressors to use when modelling fMRI data.
The output format of the regressor files are directly compatible for use with SPM, and can be adapted to fit the specifications of other toolboxes.<p></p><h1 id=getting-started>Getting started</h1><p>This tutorial assumes the following:</p><ol><li>Your data are (largely) in BIDs format</li><li>That you have converted your .zip files containing physiological data to .log files. As I was
using a CMRR multi-band sequence, I used <a href=https://github.com/CMRR-C2P/MB/blob/master/extractCMRRPhysio.m>this function</a></li><li>That your .log files are in the subject derivatives/&mldr;/sub-&mldr;/ses-&mldr;/&lsquo;func&rsquo; folders of aformentioned BIDs structured data</li><li>That you have a file that contains the motion regressors you plan to use in your GLM. I&rsquo;ll talk below a bit about what I did with the output given by fmriprep (e.g. &mldr;_desc-confounds_timeseries.tsv&rsquo;)</li><li>That you can use SPM12 and the PhysIO GUI to initialise your batch code</li></ol><p>NB. You can see the code generated from this tutorial <a href=https://github.com/kel-github/imaging_cert_value_7T_pipeline/tree/master/physiol_regress>here</a> (Coming soon!)<p></p><h1 id=1-generate-an-example-script-for-batching>1. Generate an example script for batching</h1><p>First you will create an example batch script that is specific to one of your participants. To achieve this I downloaded locally the relevant &lsquo;.log&rsquo; files for one participant, as well as the &lsquo;&mldr;desc-confounds_timeseries.tsv&rsquo; output for fmriprep for each run. PhysIO is nice in that it will append the regressors from your physiological data to your movement parameters, so that you have a single file of regressors to add to your design matrix in SPM etc (other toolboxes are available).<p></p><p>To work with PhysIO toolbox, your motion parameters need to be in the .txt format as required by SPM.</p><p>I made some simple functions in python that would extract my desired movement regressors and save them to the space separated .txt file as is required by SPM. They can be found <a href=https://github.com/kel-github/imaging_cert_value_7T_pipeline/tree/master/physiol_regress/get_movement_regressors>here</a>. (Coming soon!)</p><p>Once I had my .log files and .txt motion regressors file, I followed the instructions <a href=https://gitlab.ethz.ch/physio/physio-doc/-/wikis/QUICKSTART>here</a> to get going with the Batch editor, and used <a href=https://www.sciencedirect.com/science/article/pii/S016502701630259X>this paper</a> to aid my understanding of how to complete the fields requested by the Batch editor.</p><p>I wound up with a Batch script for the PhysIO toolbox that looked a little bit like this:</p><p><img src=/PhysIO_Batch/PhysIOBatch1.png alt=PhysIOBatch1 title=PhysIOBatch1> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><h1 id=2-generalise-the-script-for-use-with-any-participant>2. Generalise the script for use with any participant</h1><p>Now that you have an example script that contains the specific details for a single participant, you are ready to generalise this code so that you can run it for any participant you choose. I decided to do this by doing the following:</p><ul><li>First I generate an &lsquo;info&rsquo; structure for each participant. This is a structure saved as a matfile for each participant under &lsquo;derivatives&rsquo;, in the relevant sub-z/ses-y/func/ folder. This structure contains the subject specific details that PhysIO needs to know to run. Thus I wrote a matlab function that saves a structure called info with the following fields:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Matlab data-lang=Matlab><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% -- outputs: a matfile containing a structure called info with the</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% following fields:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- sub_num = subject number: [string] of form &#39;01&#39; &#39;11&#39; or &#39;111&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- sess = session number: [integer] e.g. 2</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- nrun = [integer] number of runs for that participant</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- nscans = number of scans (volumes) in the design matrix for each</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    run [1, nrun]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- cardiac_files = a cell of the cardiac files for that participant</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    (1,n = nrun) - attained by using extractCMRRPhysio()</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- respiration_files = same as above but for the resp files - attained by using extractCMRRPhysio()</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- scan_timing = info file from Siemens - attained by using extractCMRRPhysio()</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    -- movement = a cell of the movement regressor files for that</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%    participant (.txt, formatted for SPM)</span>
</span></span></code></pre></div><p>To directly see the functions that produce this information, you can go to this <a href=https://github.com/kel-github/imaging_cert_value_7T_pipeline/tree/master/physiol_regress>repo here</a> <strong>coming soon!</strong></p><ul><li>Next I amended the batch script to load a given participant&rsquo;s info file and to retrieve this information for the required fields in the batch. The batch script winds up looking like this:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Matlab data-lang=Matlab><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%% written by K. Garner, 2022</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% uses batch info:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%-----------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% Job saved on 17-Aug-2021 10:35:05 by cfg_util (rev $Rev: 7345 $)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% spm SPM - SPM12 (7771)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% cfg_basicio BasicIO - Unknown</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%-----------------------------------------------------------------------</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% load participant info, and print into the appropriate batch fields below</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% before running spm jobman</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% assumes data is in BIDS format</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%% load participant info</span>
</span></span><span style=display:flex><span><span style=color:#000>sub</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;01&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>dat_path</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;/file/path/to/top-level/of-your-derivatives-fmriprep/folder&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>task</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;attlearn&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fullfile</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dat_path</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;sub-%s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sub</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;ses-02&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;func&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>...</span>
</span></span><span style=display:flex><span>              <span style=color:#000>sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;sub-%s_ses-02_task-%s_desc-physioinfo&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sub</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#000;font-weight:700>)))</span>
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>% set variables</span>
</span></span><span style=display:flex><span><span style=color:#000>nrun</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nrun</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>nscans</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nscans</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>cardiac_files</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac_files</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>respiration_files</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>respiration_files</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>scan_timing</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>movement</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>movement</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%% initialise spm</span>
</span></span><span style=display:flex><span><span style=color:#000>spm_jobman</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;initcfg&#39;</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>% check this for later</span>
</span></span><span style=display:flex><span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;defaults&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;FMRI&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>%% run through runs, print info and run </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>irun</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>nrun</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>clear</span> <span style=color:#000>matlabbatch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>save_dir</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cellstr</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fullfile</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dat_path</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;sub-%s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sub</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;ses-02&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;func&#39;</span><span style=color:#000;font-weight:700>));</span> <span style=color:#8f5902;font-style:italic>% 1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>vendor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Siemens_Tics&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cardiac_files</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irun</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>% 2</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>respiration</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>respiration_files</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irun</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>% 3</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irun</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>% 4</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sampling_interval</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[];</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relative_start_acquisition</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log_files</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>align_scan</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;last&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Nslices</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>81</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NslicesPerBeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[];</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TR</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1.51</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Ndummies</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Nscans</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>nscans</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irun</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>% 5</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onset_slice</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>time_slice_to_slice</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[];</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sqpar</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Nprep</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[];</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scan_timing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nominal</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>modality</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;PPU&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>no</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initial_cpulse_select</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>auto_template</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>min</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initial_cpulse_select</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>auto_template</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>file</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;initial_cpulse_kRpeakfile.mat&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initial_cpulse_select</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>auto_template</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>max_heart_rate_bpm</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cardiac</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>posthoc_cpulse_select</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>off</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>respiratory</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>passband</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0.01</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>preproc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>respiratory</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>despike</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>output_multiple_regressors</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;mregress.txt&#39;</span><span style=color:#000;font-weight:700>;</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>output_physio</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;physio&#39;</span><span style=color:#000;font-weight:700>;</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>orthogonalise</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>censor_unreliable_recording_intervals</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>true</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>%false; </span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retroicor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>order</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>c</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retroicor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>order</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>r</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retroicor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>order</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cr</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rvt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>no</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>hrv</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>no</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>noise_rois</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>no</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>movement</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>file_realignment_parameters</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#000>fullfile</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dat_path</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;sub-%s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sub</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;ses-02&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;func&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;sub-%s_ses-02_task-%s_run-%d_desc-motion_timeseries.txt&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sub</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>irun</span><span style=color:#000;font-weight:700>))};</span> <span style=color:#8f5902;font-style:italic>%8</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>movement</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>order</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>movement</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>censoring_method</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;FD&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>movement</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>yes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>censoring_threshold</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.5</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>other</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>no</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>struct</span><span style=color:#000;font-weight:700>([]);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>verbose</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>level</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>verbose</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fig_output_file</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>}.</span><span style=color:#000>spm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tools</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>physio</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>verbose</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>use_tabs</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>false</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>spm_jobman</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;run&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>matlabbatch</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>end</span>
</span></span></code></pre></div><h1 id=3-ready-to-run-on-neurodesk>3. Ready to run on Neurodesk!</h1><p>Now we have a batch script, we&rsquo;re ready to run this on Neurodesk - yay!<p></p><p>First make sure the details at the top of the script are correct. You can see that this script could easily be amended to run multiple subjects.</p><p>On Neurodesk, go to the PhysIO toolbox, but select the command line tool rather than the GUI interface (&lsquo;physio r7771 instead of physioGUI r7771). This will take you to the container for the PhysIO toolbox<p></p><p><img src=/PhysIO_Batch/PhysIOBatch2.png alt=PhysIOBatch2 title=PhysIOBatch2> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><p>Now to run your PhysIO batch script, type the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>run_spm12.sh /opt/mcr/v99/ batch /your/batch/scipt/named_something.m
</span></span></code></pre></div><p>Et Voila! Physiological regressors are now yours - mua ha ha!</p></div><div class=td-content style=page-break-before:always><h1 id=pg-692ee0c0d1d645ba985513777e1a945e>3 - MRI phase Processing</h1><div class=lead>Tutorials about processing MRI phase</div></div><div class=td-content><h1 id=pg-ed3153aa84e753252b1a096df3880cc5>3.1 - Quantitative Susceptibility Mapping</h1><div class=lead>Example workflow for Quantitative Susceptibility Mapping</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=quantitative-susceptibility-mapping-in-qsmxt>Quantitative Susceptibility Mapping in QSMxT</h2><p>Neurodesk includes QSMxT, a complete and end-to-end QSM processing and analysis framework that excels at automatically reconstructing and processing QSM for large groups of participants.</p><p>QSMxT provides pipelines implemented in Python that:</p><ol><li>Automatically convert DICOM data to the Brain Imaging Data Structure (BIDS)</li><li>Automatically reconstruct QSM, including steps for:<ol><li>Robust masking without anatomical priors</li><li>Phase unwrapping (Laplacian based)</li><li>Background field removal + dipole inversion (<code>tgv_qsm</code>)</li><li>Multi-echo combination</li></ol></li><li>Automatically generate a common group space for the whole study, as well as average magnitude and QSM images that facilitate group-level analyses.</li><li>Automatically segment T1w data and register them to the QSM space to extract quantitative values in anatomical regions of interest.</li><li>Export quantitative data to CSV for all subjects using the automated segmentations, or a custom segmentation in the group space (we recommend ITK snap).</li></ol><p>If you use QSMxT for a study, please cite <a href=https://doi.org/10.1101/2021.05.05.442850>https://doi.org/10.1101/2021.05.05.442850</a> (for QSMxT) and <a href=http://www.ncbi.nlm.nih.gov/pubmed/25731991>http://www.ncbi.nlm.nih.gov/pubmed/25731991</a> (for TGVQSM)</p><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>export PATH=$PATH:~/.local/bin
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c clone /neurodesktop-storage/qsmxt-demo
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub1/GR_M_5_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub1/GR_P_6_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub2/GR_M_5_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/qsmxt-demo/osfstorage/GRE_2subj_1mm_TE20ms/sub2/GR_P_6_QSM_p2_1mmIso_TE20.zip -d /neurodesktop-storage/qsmxt-demo/dicoms
</span></span></code></pre></div><h2 id=qsmxt-usage>QSMxT Usage</h2><p>Start QSMxT (in this demo we used 1.1.9) from the applications menu in the desktop (<em>Neurodesk</em> > <em>Quantitative Imaging</em> > <em>qsmxt</em>)</p><ol><li>Convert DICOM data to BIDS:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /neurodesktop-storage/qsmxt-demo
</span></span><span style=display:flex><span>python3 /opt/QSMxT/run_0_dicomSort.py /neurodesktop-storage/qsmxt-demo/dicoms 00_dicom
</span></span><span style=display:flex><span>python3 /opt/QSMxT/run_1_dicomConvert.py 00_dicom 01_bids
</span></span></code></pre></div></li></ol><p>This will bring up an interactive question to ask you which sequence your QSM data are. It will automatically detect the QSM sequence if it has qsm or t2star in the protocol name or you can use the command line argument <code>--t2starw_series_patterns</code> to specify. This demo data comes without a structural scan (automatically recognized with t1w in the name, or specified with <code>--t1w_series_patterns</code>, so hit Enter to continue when it asks you to identify which scan the T1w scan is:</p><p><img src=https://user-images.githubusercontent.com/4021595/155911430-d2b7e904-6a8a-426c-bc27-e2167dd03a4d.png alt={DE1B0DF7-49B8-47F8-ACFF-B205F70BE58B}></p><ol start=2><li>Run QSM pipeline:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 /opt/QSMxT/run_2_qsm.py 01_bids 02_qsm_output
</span></span></code></pre></div></li></ol><p>Then you can open a viewer (Visualization -> mricrogl -> mricroglGUI) and you can find the QSM outputs in /neurodesktop-storage/qsmxt-demo/02_qsm_output/qsm_final/_run_run-1/</p><p>for example: sub-170705-134431-std-1312211075243167001_ses-1_run-1_part-phase_T2starw_scaled_qsm_000_composite_average.nii</p><p><img src=https://user-images.githubusercontent.com/4021595/155106388-72a691a4-c0a4-4cc6-a2ac-c9271888b82d.png alt=image></p><blockquote><p>Please note that the demo dataset does not have a T1w scan for anatomical segmentation and therefore the subsequent steps in QSMxT (e.g. <code>python3 /opt/QSMxT/run_3_segment.py 01_bids 03_segmentation</code>) will NOT work.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-3174433b4a44ad886176920795e9074f>3.2 - SWI</h1><div class=lead>Example workflow for SWI processing</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c fetch 01_bids.zip /neurodesktop-storage/swi-demo/01_bids.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/swi-demo/01_bids.zip -d /neurodesktop-storage/swi-demo/
</span></span></code></pre></div><p>Open the CLEARSWI tool from the application menu:</p><p>paste this julia script in a julia file and execute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>vi clearswi.jl
</span></span></code></pre></div><p>hit a or i and then paste this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>using CLEARSWI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TEs = [20] 
</span></span><span style=display:flex><span>nifti_folder = &#34;/neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat&#34;
</span></span><span style=display:flex><span>magfile = joinpath(nifti_folder, &#34;sub-170705134431std1312211075243167001_ses-1_acq-qsm_run-1_magnitude.nii.gz&#34;)
</span></span><span style=display:flex><span>phasefile = joinpath(nifti_folder, &#34;sub-170705134431std1312211075243167001_ses-1_acq-qsmPH00_run-1_phase.nii.gz&#34;) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mag = readmag(magfile);
</span></span><span style=display:flex><span>phase = readphase(phasefile);
</span></span><span style=display:flex><span>data = Data(mag, phase, mag.header, TEs);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>swi = calculateSWI(data);
</span></span><span style=display:flex><span># mip = createIntensityProjection(swi, minimum); # minimum intensity projection, other Julia functions can be used instead of minimum
</span></span><span style=display:flex><span>mip = createMIP(swi); # shorthand for createIntensityProjection(swi, minimum)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>savenii(swi, &#34;/neurodesktop-storage/swi-demo/swi.nii&#34;; header=mag.header) 
</span></span><span style=display:flex><span>savenii(mip, &#34;/neurodesktop-storage/swi-demo/mip.nii&#34;; header=mag.header)
</span></span></code></pre></div><p>hit SHIFT-Z-Z and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>julia clearswi.jl
</span></span></code></pre></div><p>Open ITK snap from the Visualization Application&rsquo;s menu and inspect the results (the outputs are in swi-demo/swi.nii and mip.nii)
<img src=https://user-images.githubusercontent.com/4021595/137708852-6b7dd2c7-3e6f-42fd-88e6-06afe87a72a9.png alt=image></p></div><div class=td-content style=page-break-before:always><h1 id=pg-359022268721811f542c4065f38891ed>3.3 - Unwrapping</h1><div class=lead>MRI Phase Unwrapping</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>cd /neurodesktop-storage/
</span></span><span style=display:flex><span>osf -p ru43c fetch 01_bids.zip /neurodesktop-storage/swi-demo/01_bids.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unzip /neurodesktop-storage/swi-demo/01_bids.zip -d /neurodesktop-storage/swi-demo/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /neurodesktop-storage/romeo-demo/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp /neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat/sub-170705134431std1312211075243167001_ses-1_acq-qsmPH00_run-1_phase.nii.gz /neurodesktop-storage/romeo-demo/phase.nii.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp /neurodesktop-storage/swi-demo/01_bids/sub-170705134431std1312211075243167001/ses-1/anat/sub-170705134431std1312211075243167001_ses-1_acq-qsm_run-1_magnitude.nii.gz /neurodesktop-storage/romeo-demo/mag.nii.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gunzip /neurodesktop-storage/romeo-demo/mag.nii.gz
</span></span><span style=display:flex><span>gunzip /neurodesktop-storage/romeo-demo/phase.nii.gz
</span></span></code></pre></div><h3 id=using-romeo-for-phase-unwrapping>Using ROMEO for phase unwrapping</h3><p>Open the ROMEO tool from the application menu and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>romeo -p /neurodesktop-storage/romeo-demo/phase.nii -m /neurodesktop-storage/romeo-demo/mag.nii -k nomask -o /neurodesktop-storage/romeo-demo/
</span></span></code></pre></div><p><img src=/MRIPhase_Tutorial/romeo.PNG alt=Romeo title=Romeo></p></div><div class=td-content style=page-break-before:always><h1 id=pg-e73d6e2f298a289114c630abc2e19e86>4 - Reproducibility</h1><div class=lead>Tutorials about performing reproducible analyses in general</div></div><div class=td-content><h1 id=pg-8a2da6b2ab26a553c2fb81d5245ed391>4.1 - Reproducible script execution with DataLad</h1><div class=lead>Using datalad run, you can precisely record results of your analysis scripts.</div><blockquote><p><em>This tutorial was created by Sin Kim.</em></p><p>Github: @AKSoo</p><p>Twitter: @SinKim98</p></blockquote><p>In addition to being a convenient method of sharing data, DataLad can also help
you create reproducible analyses by recording how certain result files were
produced (i.e. <em>provenance</em>). This helps others (and you!) easily keep track of
analyses and rerun them.</p><p>This tutorial will assume you know the basics of navigating the terminal. If
you are not familiar with the terminal at all, check the DataLad Handbook&rsquo;s
<a href=http://handbook.datalad.org/en/latest/intro/howto.html>brief guide</a>.</p><h2 id=create-a-datalad-project>Create a DataLad project</h2><p>A DataLad <em>dataset</em> can be any collection of files in folders, so it could be
many things including an analysis project. Let&rsquo;s go to the Neurodesktop storage
and create a dataset for some project. Open a terminal and enter these commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cd /storage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ datalad create -c yoda SomeProject
</span></span><span style=display:flex><span>[INFO   ] Creating a new annex repo at /home/user/Desktop/storage/SomeProject
</span></span><span style=display:flex><span>[INFO   ] Running procedure cfg_yoda
</span></span><span style=display:flex><span>[INFO   ] == Command start (output follows) =====
</span></span><span style=display:flex><span>[INFO   ] == Command exit (modification check follows) =====
</span></span><span style=display:flex><span>create(ok): /home/user/Desktop/storage/SomeProject (dataset)
</span></span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>yoda?</h4><code>-c yoda</code> option configures the dataset according to
the <a href=http://handbook.datalad.org/en/latest/basics/101-127-yoda.html>YODA</a>, a
set of intuitive organizational principles for data analyses that works
especially well with version control.</div><p>Go in the dataset and check its contents.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cd SomeProject
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>CHANGELOG.md  README.md  code
</span></span></code></pre></div><h2 id=create-a-script>Create a script</h2><p>One of DataLad&rsquo;s strengths is that it assumes very little about your datasets.
Thus, it can work with any other software on the terminal: Python, R, MATLAB,
AFNI, FSL, FreeSurfer, etc. For this tutorial, we will run the simplest Julia
script.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ ml julia
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat &gt; code/hello.jl &lt;&lt; EOF
</span></span><span style=display:flex><span>println(&#34;hello neurodesktop&#34;)
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>EOF?</h4>For sake of demonstration, we create the script using
built-in Bash terminal commands only (here document that starts after <code>&lt;&lt; EOF</code>
and ends when you enter <code>EOF</code>), but you may use whatever text editor you are
most comfortable with to create the <code>code/hello.jl</code> file.</div><p>You may want to test (parts of) your script.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ julia code/hello.jl &gt; hello.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat hello.txt
</span></span><span style=display:flex><span>hello neurodesktop
</span></span></code></pre></div><h2 id=run-and-record>Run and record</h2><p>Before you run your analyses, you should check the dataset for changes and save
or clean them.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ datalad status
</span></span><span style=display:flex><span>untracked: /home/user/Desktop/storage/SomeProject/code/hello.jl (file)
</span></span><span style=display:flex><span>untracked: /home/user/Desktop/storage/SomeProject/hello.txt (file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ datalad save -m &#39;hello script&#39; code/
</span></span><span style=display:flex><span>add(ok): code/hello.jl (file)
</span></span><span style=display:flex><span>save(ok): . (dataset)
</span></span><span style=display:flex><span>action summary:
</span></span><span style=display:flex><span>  add (ok: 1)
</span></span><span style=display:flex><span>  save (ok: 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ git clean -i
</span></span><span style=display:flex><span>Would remove the following item:
</span></span><span style=display:flex><span>  hello.txt
</span></span><span style=display:flex><span>*** Commands ***
</span></span><span style=display:flex><span>  1: clean    2: filter by pattern    3: select by numbers    4: ask each   5: quit   6: help
</span></span><span style=display:flex><span>What now&gt; 1
</span></span><span style=display:flex><span>Removing hello.txt
</span></span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>git</h4><code>git clean</code> is for removing new, untracked files. For
resetting existing, modified files to the last saved version, you would need
<code>git reset --hard</code>.</div><p>When the dataset is clean, we are ready to <code>datalad run</code>!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ mkdir outputs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ datalad run -m &#39;run hello&#39; -o &#39;outputs/hello.txt&#39; &#39;julia code/hello.jl &gt; outputs/hello.txt&#39;
</span></span><span style=display:flex><span>[INFO   ] == Command start (output follows) =====
</span></span><span style=display:flex><span>[INFO   ] == Command exit (modification check follows) =====
</span></span><span style=display:flex><span>add(ok): outputs/hello.txt (file)
</span></span><span style=display:flex><span>save(ok): . (dataset)
</span></span></code></pre></div><p>Let&rsquo;s go over each of the arguments:</p><ul><li><code>-m 'run hello'</code>: Human-readable message to record in the dataset log.</li><li><code>-o 'outputs/hello.txt'</code>: Expected output of the script. You can specify
multiple <code>-o</code> arguments and/or use wildcards like <code>'outputs/*'</code>. This script
has no inputs, but you can similarly specify inputs with <code>-i</code>.</li><li><code>'julia ... '</code>: The final argument is the command that DataLad will run.</li></ul><p>Before getting to the exciting part, let&rsquo;s do a quick sanity check.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cat outputs/hello.txt
</span></span><span style=display:flex><span>hello neurodesktop
</span></span></code></pre></div><h2 id=view-history-and-rerun>View history and rerun</h2><p>So what&rsquo;s so good about the extra hassle of running scripts with <code>datalad run</code>?
To see that, you will need to pretend you are someone else (or you of future!)
and install the dataset somewhere else. Note that <code>-s</code> argument is probably a
URL if you were really someone else.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cd ~
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ datalad install -s /neurodesktop-storage/SomeProject
</span></span><span style=display:flex><span>install(ok): /home/user/SomeProject (dataset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cd SomeProject
</span></span></code></pre></div><p>Because a DataLad dataset is a Git repository, people who download your dataset
can see exactly how <code>outputs/hello.txt</code> was created using Git&rsquo;s logs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ git log outputs/hello.txt
</span></span><span style=display:flex><span>commit 52cff839596ff6e33aadf925d15ab26a607317de (HEAD -&gt; master, origin/master, origin/HEAD)
</span></span><span style=display:flex><span>Author: Neurodesk User &lt;user@neurodesk.github.io&gt;
</span></span><span style=display:flex><span>Date:   Thu Dec 9 08:31:15 2021 +0000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [DATALAD RUNCMD] run hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    === Do not change lines below ===
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>     &#34;chain&#34;: [],
</span></span><span style=display:flex><span>     &#34;cmd&#34;: &#34;julia code/hello.jl &gt; outputs/hello.txt&#34;,
</span></span><span style=display:flex><span>     &#34;dsid&#34;: &#34;1e82813d-856f-4118-b54d-c3823e025709&#34;,
</span></span><span style=display:flex><span>     &#34;exit&#34;: 0,
</span></span><span style=display:flex><span>     &#34;extra_inputs&#34;: [],
</span></span><span style=display:flex><span>     &#34;inputs&#34;: [],
</span></span><span style=display:flex><span>     &#34;outputs&#34;: [
</span></span><span style=display:flex><span>      &#34;outputs/hello.txt&#34;
</span></span><span style=display:flex><span>     ],
</span></span><span style=display:flex><span>     &#34;pwd&#34;: &#34;.&#34;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ^^^ Do not change lines above ^^^
</span></span></code></pre></div><p>Then, using that information, they can re-run the command that created the file
using <code>datalad rerun</code>!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ datalad rerun 52cf
</span></span><span style=display:flex><span>[INFO   ] run commit 52cff83; (run hello)
</span></span><span style=display:flex><span>run.remove(ok): outputs/hello.txt (file) [Removed file]
</span></span><span style=display:flex><span>[INFO   ] == Command start (output follows) =====
</span></span><span style=display:flex><span>[INFO   ] == Command exit (modification check follows) =====
</span></span><span style=display:flex><span>add(ok): outputs/hello.txt (file)
</span></span><span style=display:flex><span>action summary:
</span></span><span style=display:flex><span>  add (ok: 1)
</span></span><span style=display:flex><span>  run.remove (ok: 1)
</span></span><span style=display:flex><span>  save (notneeded: 1)
</span></span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>git</h4>In Git, each commit (save state) is assigned a long,
unique machine-generated ID. <code>52cf</code> refers to the commit with ID that starts
with those characters. Usually 4 is the minimum needed to uniquely identify a
commit. Of course, this ID is probably different for you, so change this
argument to match your commit.</div><h2 id=see-also>See Also</h2><ul><li>To learn more basics and advanced applications of DataLad, check out the
<a href=http://handbook.datalad.org/en/latest/>DataLad Handbook</a>.</li><li>DataLad is built on top of the popular version control tool <strong>Git</strong>. There
are many great resources on Git online, like this <a href=https://git-scm.com/book/en/v2>free book</a>.</li><li>DataLad is only available on the terminal. For a detailed introduction on the
Bash terminal, check the <a href=https://mywiki.wooledge.org/BashGuide>BashGuide</a>.</li><li>For even more reproducibility, you can include <em>containers</em> with your dataset
to run analyses in. DataLad has an extension to support script execution in
containers. See <a href=http://handbook.datalad.org/en/latest/basics/101-133-containersrun.html>here</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8c40c307d7ecba12d00ebe818ffe3d8e>5 - Spectroscopy</h1><div class=lead>Tutorials about performing MR spectroscopy analyses</div></div><div class=td-content><h1 id=pg-760d47cbb109546f814f11be568e5a05>5.1 - Spectroscopy with lcmodel</h1><div class=lead>Using lcmodel, you can analyze MR spectroscopy data.</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><p>Open lcmodel from the menu: Applications -> Spectroscopy -> lcmodel -> lcmodel 6.3</p><p>run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>setup_lcmodel.sh
</span></span></code></pre></div><p>then run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>lcmgui
</span></span></code></pre></div><p>We packed example data into the container (<a href=https://zenodo.org/record/3904443/>https://zenodo.org/record/3904443/</a>) and we will use this to show a basic analysis.</p><p>The example data comes in the Varian fid format, so click on Varian:</p><img width=522 alt=image src=https://user-images.githubusercontent.com/4021595/155111509-967055c2-7ee1-4bf5-b645-6a0b1eee3328.png><p>and then select the fid data in: /opt/datasets/Spectra_hippocampus(rat)_TE02/s_20131015_03_BDL106_scan0/isise_01.fid</p><img width=751 alt=image src=https://user-images.githubusercontent.com/4021595/155111715-305678e9-0c60-4154-bdf3-3aa5ccfd7da1.png><p>Then Change BASIS and select the appropriate basis set in /opt/datasets/Spectra_hippocampus(rat)_TE02/Control_files_Basis_set</p><img width=753 alt=image src=https://user-images.githubusercontent.com/4021595/155111920-9df07a57-beb1-4507-ab7e-2c260a52d91d.png><p>Then hit Run LCModel:</p><img width=812 alt=image src=https://user-images.githubusercontent.com/4021595/155112027-11350513-7616-4158-aca7-d5c0b07397d0.png><p>and confirm:</p><img width=199 alt=image src=https://user-images.githubusercontent.com/4021595/155112122-1b93ff25-7469-4997-8aa6-e96a6784defa.png><p>then wait a couple of minutes until the analyzed spectra appear - by closing the window you can go through the results:</p><img width=893 alt=image src=https://user-images.githubusercontent.com/4021595/155112432-c91bbdef-4701-4fee-a37a-b3bf8f847843.png><p>the results are also saved in ~/.lcmodel/saved/</p></div><div class=td-content style=page-break-before:always><h1 id=pg-15c972db4ef066d5b196709a32931050>6 - Structural Imaging</h1><div class=lead>Tutorials about processing structural MRI data</div></div><div class=td-content><h1 id=pg-0fe48d9b685f097a75026e660a1fae15>6.1 - FreeSurfer</h1><div class=lead>Example workflow for FreeSurfer</div><blockquote><p><em>This tutorial was created by Steffen Bollmann.</em></p><p>Github: <a href=https://github.com/stebo85>@stebo85</a>
Web: <a href=https://mri.sbollmann.net/>mri.sbollmann.net</a>
Twitter: <a href=https://twitter.com/sbollmann_MRI>@sbollmann_MRI</a></p></blockquote><h2 id=download-demo-data>Download demo data</h2><p>Open a terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pip install osfclient
</span></span><span style=display:flex><span>osf -p bt4ez fetch TOMCAT_DIB/sub-01/ses-01_7T/anat/sub-01_ses-01_7T_T1w_defaced.nii.gz /neurodesktop-storage/sub-01_ses-01_7T_T1w_defaced.nii.gz
</span></span></code></pre></div><h2 id=freesurfer-license-file>FreeSurfer License file:</h2><p>Before using Freesurfer you need to request a license here (<a href=https://surfer.nmr.mgh.harvard.edu/registration.html>https://surfer.nmr.mgh.harvard.edu/registration.html</a>) and store it in your homedirectory as ~/.license</p><h2 id=freesurfer-example>FreeSurfer Example</h2><p>Open FreeSurfer (Neurodesk -> Image Segmentation -> Freesurfer -> Freesurfer 7.1.1)</p><p>Setup FreeSurfer license (for example - replace with your license):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>echo &#34;Steffen.Bollmann@cai.uq.edu.au
</span></span><span style=display:flex><span>&gt; 21029
</span></span><span style=display:flex><span>&gt;  *Cqyn12sqTCxo
</span></span><span style=display:flex><span>&gt;  FSxgcvGkNR59Y&#34; &gt;&gt; ~/.license
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export FS_LICENSE=~/.license 
</span></span></code></pre></div><p>Setup FreeSurfer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mkdir /neurodesktop-storage/freesurfer-output
</span></span><span style=display:flex><span>source /opt/freesurfer-7.1.1/SetUpFreeSurfer.sh
</span></span><span style=display:flex><span>export SUBJECTS_DIR=/neurodesktop-storage/freesurfer-output
</span></span></code></pre></div><p>Run Recon all pipeline:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>recon-all -subject test-subject -i /neurodesktop-storage/sub-01_ses-01_7T_T1w_defaced.nii.gz -all
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8f91ba533395ac388eb6713e856ce144>6.2 - Structural connectivity dMRI</h1><div class=lead>Example workflow for constructing strutural connectivity (Human connectome project: Single subject)</div><blockquote><p><em>This tutorial was created by Joan Amos.</em></p><p>Email: <a href=mailto:joan@std.uestc.edu.cn>joan@std.uestc.edu.cn</a>
Github: @Joanone</p></blockquote><h2 id=references>References:</h2><p>The steps used for this tutorial were referenced from:
<a href=https://github.com/civier/HCP-dMRI-connectome>https://github.com/civier/HCP-dMRI-connectome</a>
<a href=https://andysbrainbook.readthedocs.io/en/latest/MRtrix/MRtrix_Course/MRtrix_00_Diffusion_Overview.html>https://andysbrainbook.readthedocs.io/en/latest/MRtrix/MRtrix_Course/MRtrix_00_Diffusion_Overview.html</a>
<a href=https://mrtrix.readthedocs.io/en/latest/quantitative_structural_connectivity/structural_connectome.html>https://mrtrix.readthedocs.io/en/latest/quantitative_structural_connectivity/structural_connectome.html</a></p><h2 id=data-description>Data Description</h2><h3 id=reference>Reference:</h3><p>The single subject data used in this tutorial has been preprocessed and was downloaded from:</p><p><a href=https://db.humanconnectome.org/>https://db.humanconnectome.org/</a></p><p>100307_3T_Structural_preproc.zip
100307_3T_Diffusion_preproc.zip</p><h3 id=download-demo-data>Download demo data:</h3><p><a href="https://1drv.ms/u/s!AjZJgBZ_P9UO8nWvAFwQyKQnrroe?e=6qmRlQ">https://1drv.ms/u/s!AjZJgBZ_P9UO8nWvAFwQyKQnrroe?e=6qmRlQ</a> - Diffusion data
<a href="https://1drv.ms/u/s!AjZJgBZ_P9UO8nblYQyUVsibqggs?e=mkwLpQ">https://1drv.ms/u/s!AjZJgBZ_P9UO8nblYQyUVsibqggs?e=mkwLpQ</a> - Structural data</p><h3 id=required-structural-preprocessed-input-files>Required structural preprocessed input files</h3><p>aparc+aseg.nii.gz
T1w_acpc_dc_restore_brain.nii.gz</p><h3 id=required-diffusion-preprocessed-input-files>Required diffusion preprocessed input files</h3><p>bvals
bvecs
data.nii.gz</p><h2 id=install-neurodesk-on-windows-and-mount-external-storage-on-your-host-computer>Install Neurodesk on windows and mount external storage on your host computer</h2><p>References:
<a href=https://neurodesk.github.io/docs/neurodesktop/getting-started/windows/>https://neurodesk.github.io/docs/neurodesktop/getting-started/windows/</a>
<a href=https://neurodesk.github.io/docs/neurodesktop/storage/>https://neurodesk.github.io/docs/neurodesktop/storage/</a></p><p>N/B: Constructing the structural connectivity using dMRI HCP data is computationally intensive. Thus, ensure you have sufficient disk space (>100GB) and RAM size (16, 32GB)</p><p>Open the powershell terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --shm-size=1gb -it --privileged --name neurodesktop -v C:/neurodesktop-storage:/neurodesktop-storage -v D:/moredata:/data -p 8080:8080 -h neurodesktop-20220222 vnmd/neurodesktop:20220222
</span></span></code></pre></div><h2 id=navigate-to-the-mounted-storage--more-data--create-a-new-folder-of-your-choice---copy-the-required-input-files-into-a-folder-100307>Navigate to the mounted storage&ndash;>more data&ndash;>Create a new folder of your choice&ndash;> copy the required input files into a folder->100307</h2><p>N/B: The folder created in this tutorial was tagged &ldquo;Test&rdquo;</p><p>Open a terminal in neurodesk and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>cd/data/Test/100307
</span></span></code></pre></div><h2 id=activate-mrtrix3-software-in-the-neurodesk-terminal>Activate mrtrix3 software in the neurodesk terminal</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>ml mrtrix3/3.0.3
</span></span></code></pre></div><p>N/B: The advantage neurodesk offers is the version of software can be selected from a range of others, which caters for reproducibility. The mrtrix3 (3.0.3) version was used in this tutorial.</p><h2 id=step-1-further-pre-processing>Step 1: Further pre-processing</h2><p>Extract data.nii.gz to enable memory-mapping. The extracted files are about 4.5GB:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>gunzip -c data.nii.gz &gt; data.nii; 
</span></span><span style=display:flex><span>mrconvert data.nii DWI.mif -fslgrad bvecs bvals -datatype float32 -stride 0,0,0,1 -force -info;
</span></span><span style=display:flex><span>rm -f data.nii
</span></span></code></pre></div><p>Perform mrconvert:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>dwibiascorrect ants DWI.mif DWI_bias_ants.mif -bias bias_ants_field.mif -force -info;
</span></span></code></pre></div><p>Extract the response function. Uses -stride 0,0,0,1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>dwi2response dhollander DWI_bias_ants.mif response_wm.txt response_gm.txt response_csf.txt -voxels RF_voxels.mif -force; 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>dwiextract DWI_bias_ants.mif - -bzero | mrmath - mean meanb0.mif -axis 3 -force -info
</span></span></code></pre></div><p>Generate mask:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>dwi2mask DWI_bias_ants.mif DWI_mask.mif -force -info;
</span></span></code></pre></div><p>Generate Fibre Orientation Distributions (FODs):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>dwi2fod msmt_csd DWI_bias_ants.mif response_wm.txt wmfod.mif response_gm.txt gm.mif  response_csf.txt csf.mif -mask DWI_mask.mif -force -info;
</span></span></code></pre></div><p>Perform normalization:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>mtnormalise wmfod.mif wmfod_norm.mif gm.mif gm_norm.mif csf.mif csf_norm.mif -mask DWI_mask.mif -check_norm mtnormalise_norm.mif -check_mask mtnormalise_mask.mif -force -info
</span></span></code></pre></div><p>Generate a 5 tissue image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>5ttgen fsl T1w_acpc_dc_restore_brain.nii.gz 5TT.mif -premasked 
</span></span></code></pre></div><p>Convert the B0 image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mrconvert meanb0.mif mean_b0.nii.gz
</span></span></code></pre></div><p>Activate the fsl and afni softwares in the neurodesk terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ml fsl/6.0.3
</span></span><span style=display:flex><span>ml afni/21.0.0
</span></span></code></pre></div><p>Use &ldquo;fslroi&rdquo; to extract the first volume of the segmented dataset which corresponds to the Grey Matter Segmentation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>fslroi 5TT.nii.gz 5TT_vol0.nii.gz 0 
</span></span></code></pre></div><p>Use &ldquo;flirt&rdquo; command to coregister the two datasets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>flirt -in  mean_b0.nii.gz -ref  5TT_vol0.nii.gz -interp nearestneighbour -dof 6 -omat diff2struct_fsl.mat
</span></span></code></pre></div><p>Convert the transformation matrix to a format readble by MRtrix:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>transformconvert diff2struct_fsl.mat mean_b0.nii.gz 5TT.nii.gz flirt_import diff2struct_mrtrix.txt
</span></span></code></pre></div><p>Coregister the anatomical image to the diffusion image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>mrtransform 5TT.mif -linear diff2struct_mrtrix.txt -inverse 5TT_coreg 
</span></span></code></pre></div><p>Create the seed boundary which sepearates the grey from the white matter. The command &ldquo;5tt2gmwmi&rdquo; denotes (5 tissue type(segmentation) to grey matter/white matter interface):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>5tt2gmwmi 5TT_coreg.mif gmwmSeed_coreg.mif
</span></span></code></pre></div><h2 id=step-2-tractogram-construction>Step 2: Tractogram construction</h2><p>The probabilistic tractography which is the default in MRtrix is used in this tutorial. The default method is the iFOD2 algorithm.
The number of streamlines used is 10 million, this was chosen to save computational time:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tckgen -act 5TT_coreg.mif -backtrack -seed_gmwmi gmwmSeed_coreg.mif -nthreads 8 -minlength 5.0 -maxlength 300 -cutoff 0.06 -select 10000000 wmfod_norm.mif tracks_10M.tck -force
</span></span></code></pre></div><h2 id=step-3-sift2-construction>Step 3: SIFT2 construction</h2><p>The generated streamlines can be refined with tcksift2 to counterbalance the overfitting. This creates a text file containing weights for each voxel in the brain:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tcksift2 -act 5TT_coreg.mif -out_mu sift_mu.txt -out_coeffs sift_coeffs.txt -nthreads 8 tracks.tck wmfod_norm.mif sift_1M.txt -force
</span></span></code></pre></div><h2 id=step-4-connectome-construction>Step 4: Connectome construction</h2><p>In constructing the connectome, the desikan-killany atlas which includes the cortical and sub-cortical regions (84 regions) was used.</p><p>Copy the FreeSurferColorLUT.txt file from the ml freesurfer 7.2.0 singularity container to the subject&rsquo;s folder</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cp /opt/freesurfer-7.2.0/FreeSurferColorLUT.txt /data/Test/100307
</span></span></code></pre></div><p>Copy the fs_default.txt file from the ml mrtrix3 3.0.3 singularity container to the subject&rsquo;s folder</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cp /opt/mrtrix3-3.0.3/share/mrtrix3/labelconvert/fs-default.txt /data/Test/100307
</span></span></code></pre></div><p>The command labelconvert will use the parcellation and segmentation output of FreeSurfer to create a new parcellated file in .mif format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>labelconvert aparc+aseg.nii.gz FreeSurferColorLUT.txt fs_default.txt nodes.mif -force
</span></span></code></pre></div><p>Perform nodes co-registeration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>mrtransform nodes.mif -linear diff2struct_mrtrix.txt -inverse -datatype uint32 nodes_coreg.mif -force
</span></span></code></pre></div><p>Create a whole-brain connectome which denotes the streamlines between each parcellation pair in the atlas. The &ldquo;symmetric&rdquo; option makes the lower and upper diagonal the same, the &ldquo;scale_invnodevol&rdquo; option scales the connectome by the inverse of the size of the node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tck2connectome -symmetric -zero_diagonal -scale_invnodevol -tck_weights_in sift_1M.txt tracks.tck nodes_coreg.mif  nodes.csv -out_assignment  assignments_nodes.csv -force
</span></span></code></pre></div><h2 id=viewing-the-connectome>Viewing the connectome</h2><p>The generated nodes.csv file can be viewed outside neurodesk as a matrix in Matlab.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>connectome=importdata(&#39;nodes.csv&#39;);
</span></span><span style=display:flex><span>imagesc(connectome,[0 1])
</span></span></code></pre></div><p><img src=/Structural_connectivity_dMRI/Structural_connectivity.png alt=Structural_connectivity title=Structural_connectivity> &ndash;></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d3542de6d1d1b0ffa46b2886fe35344>7 - Documentation</h1><div class=lead>Tutorials on contributing to the Neurodesk Documentation</div></div><div class=td-content><h1 id=pg-b0590b6e45cbf130ebe8a6b8b8677519>7.1 - Template for workflow creation</h1><div class=lead>Follow this template to contribute your own workflow to the Neurodesk documentation.</div><blockquote><p><em>This tutorial was created by Name P. Namington.</em></p><p>Email: <a href=mailto:n.namington@institution.edu.au>n.namington@institution.edu.au</a></p><p>Github: @Namesgit</p><p>Twitter: @Nameshandle</p></blockquote><p>Welcome to the workflow template, which you can use to contribute your own neurodesk workflow to our documentation. We aim to collect a wide variety of workflows representing the spectrum of tools available under the neurodesk architechture and the diversity in how researchers might apply them. Please add plenty of descriptive detail and make sure that all steps of the workflow work before submitting the tutorial.</p><h2 id=how-to-contribute-a-new-workflow>How to contribute a new workflow</h2><p>Begin by creating a copy of our documentation that you can edit:</p><ol><li>Visit the github repository for the Neurodesk documentation (<a href=https://github.com/NeuroDesk/neurodesk.github.io)>https://github.com/NeuroDesk/neurodesk.github.io)</a>.</li><li><a href=https://docs.github.com/en/get-started/quickstart/fork-a-repo>Fork</a> the repository.</li></ol><ul><li><em>You should now have your own copy of the documentation, which you can alter without affecting our official documentation. You should see a panel stating &ldquo;This branch is up to date with Neurodesk:hugo-docsy.&rdquo; If someone else makes a change to the official documentation, the statement will change to reflect this. You can bring your repository up to date by clicking &ldquo;Fetch upstream&rdquo;.</em></li></ul><p>Next, create your workflow:</p><ol><li><a href=https://docs.github.com/en/get-started/quickstart/fork-a-repo#cloning-your-forked-repository>Clone</a> your forked version of our documentation to a location of your choice on your computer.</li><li>In this new folder, navigate to &ldquo;neurodesk.github.io/content/en/tutorials&rdquo; and then navigate to the subfolder you believe your workflow belongs in (e.g. &ldquo;/functional_imaging&rdquo;).</li><li>Create a new, appropriately named markdown file to house your workflow. (e.g. &ldquo;/physio.md&rdquo;)</li><li>Open this file in the editor of your choice (we recommend <a href=https://code.visualstudio.com/>vscode</a>) and populate it with your workflow! Please use this template as a style guide, it can be located at &ldquo;neurodesk.github.io\content\en\tutorials\documentation\workflowtemplate.md&rdquo;. You&rsquo;re also welcome to have a look at other the workflows already documented on our website for inspiration.</li></ol><p>Finally, contribute your new workflow to the official documentation!:</p><ol><li>Once you are happy with your workflow, make sure you <a href=https://github.com/git-guides/git-commit>commit</a> all your changes and <a href=https://github.com/git-guides/git-push>push</a> these local commits to github.</li><li>Navigate to your forked version of the repository on github.</li><li>Before you proceed, make sure you are up to date with our upstream documentation, you may need to <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork>fetch upstream changes</a>.</li><li>Now you can preview the changes before contributing them upstream. For this click on the &ldquo;Actions&rdquo; tab and enable the Actions (&ldquo;I understand my workflows&mldr;&rdquo;). The first build will fail (due to a bug with the Github token), but the second build will work.</li><li>Then you need to open the settings of the repository and check that Pages points to gh-pages and when clicking on the link the site should be there.</li><li>To contribute your changes, click &ldquo;Contribute&rdquo;, and then <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests>&ldquo;Open pull request&rdquo;</a>.</li><li>Give your pull request a title (e.g. &ldquo;Document PhysIO workflow&rdquo;), leave a comment briefly describing what you have done, and then create the pull request.</li><li>Someone from the Neurodesk team will review and accept your workflow and it will appear on our website soon!.</li></ol><p>Thanks so much for taking the time to contribute your workflow to the Neurodesk community! If you have any feedback on the process, please let us know on <a href=https://github.com/NeuroDesk/neurodesk.github.io/discussions>github discussions</a>.</p><h2 id=formatting-guidelines>Formatting guidelines</h2><p>You can embelish your text in this tutorial using markdown conventions; text can be <strong>bold</strong>, <em>italic</em>, or <del>strikethrough</del>. You can also add <a href=https://www.neurodesk.org/>Links</a>, and you can organise your tutorial with headers, starting at level 2 (the page title is a level 1 header):</p><h2 id=level-2-heading>Level 2 heading</h2><p>You can also include progressively smaller subheadings:</p><h3 id=level-3-heading>Level 3 heading</h3><p>Some more detailed information.</p><h4 id=level-4-heading>Level 4 heading</h4><p>Even more detailed information.</p><h3 id=code-blocks>Code blocks</h3><p>You can add codeblocks to your tutorial as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Some example code
</span></span><span style=display:flex><span>import numpy as np
</span></span><span style=display:flex><span>a = np.array([1, 2])
</span></span><span style=display:flex><span>b = np.array([3, 4])
</span></span><span style=display:flex><span>print(a+b)
</span></span></code></pre></div><p>Or add syntax highlighting to your codeblocks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>Some</span> <span style=color:#000>example</span> <span style=color:#000>code</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>numpy</span> <span style=color:#000>as</span> <span style=color:#000>np</span>
</span></span><span style=display:flex><span><span style=color:#000>a</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>([</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Advanced code or command line formatting using this html snippet:</p><pre class="language-shell command-line" data-prompt=">>>" data-output=6>
<code># Some example code
import numpy as np
a = np.array([1, 2])
b = np.array([3, 4])
print(a+b)
[4 6]</code>
</pre><p>You can also add code snippets, e.g. <code>var foo = "bar";</code>, which will be shown inline.</p><h3 id=images>Images</h3><p>To add screenshots to your tutorial, create a subfolder in <code>neurodesk.github.io/static</code> with the same link name as your tutorial. Add your screenshot to this folder, keeping in mind that you may want to adjust your screenshot to a reasonable size before uploading. You can then embed these images in your tutorial using the following convention:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>![EEGtut1](/EEG_Tutorial/EEGtut1.png &#39;EEGtut1&#39;) &lt;!-- ![filename without extension](/subfolder_name/filename.png &#39;[filename without extension&#39;)  --&gt;
</span></span></code></pre></div><p><img src=/EEG_Tutorial/EEGtut1.png alt=EEGtut1 title=EEGtut1> &lt;!&ndash; <img src=/subfolder_name/filename.png alt="filename without extension" title="[filename without extension"> &ndash;></p><h3 id=alerts-and-warnings>Alerts and warnings</h3><p>You can grab reader&rsquo;s attention to particularly important information with quoteblocks, alerts and warnings:</p><blockquote><p>This is a quoteblock</p></blockquote><p><div class="alert alert-primary" role=alert>This is an alert.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>This is an alert with a title.</div><div class="alert alert-warning" role=alert>This is a warning.</div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>This is a warning with a title.</div></p><p>You can also segment information as follows:</p><hr><p>There&rsquo;s a horizontal rule above and below this.</p><hr><p>Or add page information:<div class="pageinfo pageinfo-primary"><p>This is a placeholder. Replace it with your own content.</p></div></p><h3 id=tables>Tables</h3><p>You may want to order information in a table as follows:</p><table><thead><tr><th>Neuroscientist</th><th>Notable work</th><th>Lifetime</th></tr></thead><tbody><tr><td>Santiago Ramón y Cajal</td><td>Investigations on microscopic structure of the brain</td><td>1852–1934</td></tr><tr><td>Rita Levi-Montalcini</td><td>Discovery of nerve growth factor (NGF)</td><td>1909–2012</td></tr><tr><td>Anne Treisman</td><td>Feature integration theory of attention</td><td>1935–2018</td></tr></tbody></table><h3 id=lists>Lists</h3><p>You may want to organise information in a list as follows:</p><p>Here is an unordered list:</p><ul><li>Rstudio</li><li>JASP</li><li>SPSS</li></ul><p>And an ordered list:</p><ol><li>Collect data</li><li>Try to install analysis software</li><li>Cry a little</li></ol><p>And an unordered task list:</p><ul><li><input checked disabled type=checkbox> Install Neurodesktop</li><li><input checked disabled type=checkbox> Analyse data</li><li><input disabled type=checkbox> Take a vacation</li></ul><p>And a &ldquo;mixed&rdquo; task list:</p><ul><li><input disabled type=checkbox> writing</li><li>?</li><li><input disabled type=checkbox> more writing probably</li></ul><p>And a nested list:</p><ul><li>EEG file extensions<ul><li>.eeg, .vhdr, .vmrk</li><li>.edf</li><li>.bdf</li><li>.set, .fdt</li><li>.smr</li></ul></li><li>MEG file extensions<ul><li>.ds</li><li>.fif</li><li>.sqd</li><li>.raw</li><li>.kdf</li></ul></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/neuro_desk aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dicussion Forum (requires github login)" aria-label="Dicussion Forum (requires github login)"><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk/neurodesk.github.io/discussions aria-label="Dicussion Forum (requires github login)"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.2b242016bd393aa86ff3b4500b2baae3b55d65f622435861b9338518eb4a5f69.js integrity="sha256-KyQgFr05Oqhv87RQCyuq47VdZfYiQ1hhuTOFGOtKX2k=" crossorigin=anonymous></script>
<script src=/js/prism.js></script></body></html>