<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.94.0"><link rel=canonical type=text/html href=https://www.neurodesk.org/developers/><link rel=alternate type=application/rss+xml href=https://www.neurodesk.org/developers/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Developers | NeuroDesk</title><meta name=description content="Documentation for Developers
"><meta property="og:title" content="Developers"><meta property="og:description" content="Documentation for Developers
"><meta property="og:type" content="website"><meta property="og:url" content="https://www.neurodesk.org/developers/"><meta property="og:site_name" content="NeuroDesk"><meta itemprop=name content="Developers"><meta itemprop=description content="Documentation for Developers
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Developers"><meta name=twitter:description content="Documentation for Developers
"><link rel=preload href=/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css as=style><link href=/scss/main.min.8ae326e95d9c6881ebe419ebd82c6634a8ac6728b2415ccd672d345f03b4cb1b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-221108279-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">NeuroDesk</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/how-to-cite-us/><span>Cite</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/applications/><span>Applications</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/developers/><span class=active>Developers</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/tutorials/><span>Tutorials</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/NeuroDesk target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://twitter.com/neuro_desk target=_blank><span>News</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.fe2658b0be6c6853304976b4f8aa4f83.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/developers/>Return to the regular view of this page</a>.</p></div><h1 class=title>Developers</h1><div class=lead>Documentation for Developers</div><ul><li>1: <a href=#pg-15acb6ef1ed3edc78a7113c206dd126e>Contributors</a></li><ul></ul><li>2: <a href=#pg-95ed7c5681d2faa66b764be030124e59>Architecture</a></li><ul><li>2.1: <a href=#pg-d2ee0d937ef9e23352513cee17667503>Neurodesktop Release Process</a></li><li>2.2: <a href=#pg-0520384e83c6213075507d31fd6fd347>Neurodesk Architecture</a></li><li>2.3: <a href=#pg-4e0ebcb307acf80f9f0f9d5fcf769e45>Neurodesktop Dev</a></li></ul><li>3: <a href=#pg-f347e8a68ab88feb2dbd40d7268e3b66>Documentation</a></li><ul><li>3.1: <a href=#pg-43caa4b2a10189e2fa053496d5d16e07>Local Hugo Docsy</a></li></ul><li>4: <a href=#pg-fd28a1b5010f2ff02bb480802674fb39>How to add new tools</a></li><ul><li>4.1: <a href=#pg-c122ef84d9e99678ee0fc712da87cffa>Get Neurodesk code</a></li><li>4.2: <a href=#pg-bd6045c57eea320a927f9a85200b8697>Using Git</a></li><li>4.3: <a href=#pg-e24a02244ddbf4a83fcf0095e3003590>Add tools</a></li><li>4.4: <a href=#pg-d8e9695a04ad28c1d14505b5b444f9cb>Fix commit</a></li><li>4.5: <a href=#pg-d633e953d580caca810a21667c2cd386>Create a pull request</a></li><li>4.6: <a href=#pg-be505b3d9e340052f832ece047956369>Troubleshooting</a></li><li>4.7: <a href=#pg-f706aedba5bc93ee895c966642b91365>Menu entries</a></li></ul><li>5: <a href=#pg-f89498a0fd2d201e1dc7e27d7be9f337>Transparent Singularity</a></li><ul></ul><li>6: <a href=#pg-9dfb256e35d7dd91e05a33ec675f72e4>Neurodesk CVMFS</a></li><ul><li>6.1: <a href=#pg-7d2cf5c0520f7ea412450bf2c795e035>Setup CVMFS Proxy</a></li><li>6.2: <a href=#pg-d12eca793afb912a040cd1c047606b56>CVMFS architecture</a></li><li>6.3: <a href=#pg-9110e9d9e3591f58026d3d52fc7e72cb>Setup Stratum 0 server</a></li><li>6.4: <a href=#pg-c25efc2b343b28af52b4173ce3a803a3>Setup Stratum 1 server</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-15acb6ef1ed3edc78a7113c206dd126e>1 - Contributors</h1><div class=lead>This section acknowledges the contributions made to the project.</div><p>If you contributed to the project please list yourself here with a description of your contribution. We try to update this page based on the git commit history:</p><ul><li><a href=https://github.com/NeuroDesk/neurodesktop/graphs/contributors>https://github.com/NeuroDesk/neurodesktop/graphs/contributors</a></li><li><a href=https://github.com/NeuroDesk/neurocommand/graphs/contributors>https://github.com/NeuroDesk/neurocommand/graphs/contributors</a></li><li><a href=https://github.com/NeuroDesk/neurocontainers/graphs/contributors>https://github.com/NeuroDesk/neurocontainers/graphs/contributors</a></li><li><a href=https://github.com/NeuroDesk/neurodesk.github.io/graphs/contributors>https://github.com/NeuroDesk/neurodesk.github.io/graphs/contributors</a></li><li><a href=https://github.com/NeuroDesk/transparent-singularity/graphs/contributors>https://github.com/NeuroDesk/transparent-singularity/graphs/contributors</a></li></ul><h2 id=steffen-bollmann>Steffen Bollmann</h2><ul><li><a href=https://github.com/stebo85>https://github.com/stebo85</a></li><li>funding: Oracle Cloud (114k AUD), ECR Knowledge Exchange & Translation Fund (42k AUD), ARDC (CI for $566k AUD)</li><li>system architecture</li><li>CVMFS container deployment</li><li>initial desktop container prototype</li><li>container build scripts</li><li>application containers (afni, aslprep, code, convert3D, freesurfer, hdbet, minc mriqc, romeo, spm12, tgvqsm, bart, fatsegnet, fsl, itksnap, lcmodel, mritools, niistat, qsmxt, root, slicer, trackvis, ants, cat12, conn, diffusiontoolkit, gimp, mricrogl, mrtrix3, rstudio, slicersalt, surfice, vesselapp, bidstools, clearswi, connectomeworkbench, dsistudio, fmriprep, julia, mrtrix3tissue, palm rabies, spinalcordtoolbox)</li><li>migrating container recipes and bugfixes to neurodocker upstream (fsl, ants)</li><li>documentation</li><li>tutorials (QSM, SWI, Unwrapping, lcmodel, freesurfer)</li><li>google colab support</li><li>outreach (e.g. Twitter, talks at conferences, youtube videos)</li></ul><h2 id=aswin-narayanan>Aswin Narayanan</h2><ul><li><a href=https://github.com/aswinnarayanan>https://github.com/aswinnarayanan</a></li><li>funding: ARDC (CI for $566k AUD)</li><li>Neurocontainer devops</li><li>Neurodesktop development</li><li>Neurocommand installer rewrite</li><li>Neurodesk Play & Kubernetes implementation</li><li>Jupyter notebook support</li><li>Hugo website build and documentation</li></ul><h2 id=angela-renton>Angela Renton</h2><ul><li><a href=https://github.com/air2310>https://github.com/air2310</a></li><li>Tutorials (MNE-Python, Tutorial template)</li><li>graphics for website (layer diagram)</li><li>documentation</li><li>user testing</li><li>neurodesk paper lead author</li></ul><h2 id=thomas-shaw>Thomas Shaw</h2><ul><li><a href=https://github.com/thomshaw92>https://github.com/thomshaw92</a></li><li>Win, Mac, Linux startup scripts</li><li>initial transparent singularity prototype</li><li>application container development (LASHiS, ASHS)</li><li>user testing</li></ul><h2 id=oren-civier>Oren Civier</h2><ul><li><a href=https://github.com/civier>https://github.com/civier</a></li><li>funding: ARDC (CI for $566k AUD)</li><li>documentation</li><li>softare application containers (bidscoin)</li><li>user testing</li></ul><h2 id=tom-johnston>Tom Johnston</h2><ul><li><a href=https://github.com/TomEmotion>https://github.com/TomEmotion</a></li><li>funding: ARDC (PI for $566k AUD)</li><li>Application Container (sigviewer)</li></ul><h2 id=martin-grignard>Martin Grignard</h2><ul><li><a href=https://github.com/MartinGrignard>https://github.com/MartinGrignard</a></li><li>initial neurocommand prototype and menu system builder, including apps.json idea</li></ul><h2 id=david-white>David White</h2><ul><li><a href=https://github.com/DavidjWhite33>https://github.com/DavidjWhite33</a></li><li>application container development (Brainstorm, eeglab, fieldtrip)</li></ul><h2 id=akshaiy-narayanan>Akshaiy Narayanan</h2><ul><li><a href=https://github.com/Akshaiy91>https://github.com/Akshaiy91</a></li><li>bugfixes in neurodesktop, added tool for diskusage, checking of new version script</li></ul><h2 id=kelly-garner>Kelly Garner</h2><ul><li><a href=https://github.com/kel-github>https://github.com/kel-github</a></li><li>tutorials (fmriprep, mriqc, physio batch)</li><li>user testing on MacOS</li></ul><h2 id=paris-lyons>Paris Lyons</h2><ul><li>design of Neurodesk Logo</li><li>project management of AEDAPT project</li></ul><h2 id=thuy-dao>Thuy Dao</h2><ul><li><a href=https://github.com/iishiishii>https://github.com/iishiishii</a></li><li>Application search tool with lunr</li><li>proof of concept for GUI</li><li>application container development (civet)</li><li>documentation (github workflow)</li></ul><h2 id=ashley-stewart>Ashley Stewart</h2><ul><li><a href=https://github.com/astewartau>https://github.com/astewartau</a></li><li>application container development (qsmxt)</li><li>presentation of neurodesk at OHBM Brainhack 2022 and OHBM educational course 2022</li></ul><h2 id=lars-kasper>Lars Kasper</h2><ul><li><a href=https://github.com/mrikasper>https://github.com/mrikasper</a></li><li>tutorials (physio)</li><li>Application Container (physio)</li></ul><h2 id=judy-d-zhu>Judy D Zhu</h2><ul><li><a href=https://github.com/JD-Zhu>https://github.com/JD-Zhu</a></li><li>application containers (fieldtrip)</li><li>tutorials (fieldtrip)</li></ul><h2 id=korbinian-eckstein>Korbinian Eckstein</h2><ul><li><a href=https://github.com/korbinian90>https://github.com/korbinian90</a></li><li>documentation</li><li>application container development (qsmxt)</li></ul><h2 id=stefanie-evas>Stefanie Evas</h2><ul><li><a href=https://github.com/neuro-sevas>https://github.com/neuro-sevas</a></li><li>documentation</li><li>application containers</li></ul><h2 id=jeryn-chang>Jeryn Chang</h2><ul><li><a href=https://github.com/Cadaei-Yuvxvs>https://github.com/Cadaei-Yuvxvs</a></li><li>application container development (oshyx)</li></ul><h2 id=sin-kim>Sin Kim</h2><ul><li><a href=https://github.com/AKSoo>https://github.com/AKSoo</a></li><li>tutorial (datalad)</li></ul><h2 id=jakub-kaczmarzyk>Jakub Kaczmarzyk</h2><ul><li><a href=https://github.com/kaczmarj>https://github.com/kaczmarj</a></li><li>proof of concept contributions</li></ul><h2 id=alan-hockings>Alan Hockings</h2><ul><li><a href=https://github.com/ahockings>https://github.com/ahockings</a></li><li>application container development (mricron)</li></ul><h2 id=aditya-garg>Aditya Garg</h2><ul><li><a href=https://github.com/adityagarg011>https://github.com/adityagarg011</a></li><li>application container development (hdbet)</li></ul><h2 id=xincheng-ye>Xincheng Ye</h2><ul><li><a href=https://github.com/yexincheng>https://github.com/yexincheng</a></li><li>application container development (delphi)</li></ul><h2 id=kexin-lou>Kexin Lou</h2><ul><li><a href=https://github.com/Kaxnn>https://github.com/Kaxnn</a></li><li>application container development (mne/torch,esilpd)</li></ul><h2 id=renzo-huber>Renzo Huber</h2><ul><li><a href=https://github.com/layerfMRI>https://github.com/layerfMRI</a></li><li>application container development (laynii)</li></ul><h2 id=steering-committee-members-without-code-contributions>Steering Committee members without code contributions:</h2><ul><li>Ryan Sullivan, University of Sydney, Key User, Steering Committee</li><li>Thomas Close, University of Sydney, Key User, Scientific/Subject Expert Advisory Board</li><li>Wojtek Goscinski, Monash University, Steering Committee, Technical Advisory Board</li><li>Tony Hannan, Florey Institute of Neuroscience and Mental Health, Scientific/Subject Expert Advisory Board</li><li>Gary Egan, Monash University, Steering Committee</li><li>Paul Sowman, Macquarie University, Key User, Scientific/Subject Expert Advisory Board</li><li>Marta Garrido, University of Melbourne, Key User, Scientific/Subject Expert Advisory Board</li><li>Patrick Johnston, Queensland University of Technology, Key User, Scientific/Subject Expert Advisory Board</li><li>Aina Puce, Indiana University, Key User, Scientific/Subject Expert Advisory Board</li><li>Franco Pestilli, Indiana University, Technical Advisory Board</li><li>Levin Kuhlmann, Monash University, Key User, Scientific/Subject Expert Advisory Board</li><li>Gershon Spitz, Monash Epworth Rehabilitation Research Centre, Key User, Scientific/Subject Expert Advisory Board</li><li>David Abbott, Florey Institute of Neuroscience and Mental Health, Key User, Scientific/Subject Expert Advisory Board</li><li>Megan Campbell, The University of Newcastle, Key User, Scientific/Subject Expert Advisory Board</li><li>Nigel Rogasch, University of Adelaide, Key User, Scientific/Subject Expert Advisory Board</li><li>Will Woods, Swinburne University of Technology, Key User</li><li>Satrajit Ghosh, Massachusetts Institute of Technology, Provision of advice only</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-95ed7c5681d2faa66b764be030124e59>2 - Architecture</h1><div class=lead>The architecture of the Neurodesk ecosystem</div></div><div class=td-content><h1 id=pg-d2ee0d937ef9e23352513cee17667503>2.1 - Neurodesktop Release Process</h1><div class=lead>A description of what to do to create new release of our Neurodesktop</div><ol><li>Check if the last automated build ran OK: <a href=https://github.com/NeuroDesk/neurodesktop/actions>https://github.com/NeuroDesk/neurodesktop/actions</a></li><li>Run this build date and test if everything is ok and no regression happened</li><li>Check what changes where made since the last release: <a href=https://github.com/NeuroDesk/neurodesktop/commits/main>https://github.com/NeuroDesk/neurodesktop/commits/main</a></li><li>Summarize the main changes and copy this to the Release History: <a href=https://www.neurodesk.org/docs/neurodesktop/release-history/>https://www.neurodesk.org/docs/neurodesktop/release-history/</a></li><li>Change the version of the latest desktop in <a href=https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/data/neurodesktop.toml>https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/data/neurodesktop.toml</a></li><li>Commit all changes</li><li>Tweet a quick summary of the changes and announce new version: <a href=https://twitter.com/neuro_desk>https://twitter.com/neuro_desk</a></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-0520384e83c6213075507d31fd6fd347>2.2 - Neurodesk Architecture</h1><div class=lead>The architecture of the Neurodesk ecosystem</div><h1 id=layers>Layers</h1><p>Neurodesktop: <a href=https://github.com/NeuroDesk/neurodesktop>https://github.com/NeuroDesk/neurodesktop</a></p><ul><li>docker container with interface modifications</li><li>contains tools necessary to manage workflows in sub-containers: vscode, git</li><li>CI: builds docker image and tests if it runs; tests if CVMFS servers are OK before deployment</li><li>CD: pushes images to github & docker registry</li></ul><p>Neurocommand: <a href=https://github.com/NeuroDesk/neurocommand>https://github.com/NeuroDesk/neurocommand</a></p><ul><li>script to install and manage multiple containers using transparent singularity on any linux system</li><li>this repo also handles the creation of menu entries in a general form applicable to different desktop environments</li><li>this repo can be re-used in other projects like CVL and when installing it on bare-metal workstations</li><li>CI: tests if containers can be installed</li><li>CD: this repo checks if containers requested in apps.json file are availabe on object storage and if not converts the singularity containers based on the docker containers and uploads them to object storage</li></ul><p>transparent-singularity: <a href=https://github.com/NeuroDesk/transparent-singularity>https://github.com/NeuroDesk/transparent-singularity</a></p><ul><li>script to install neuro-sub-containers, installers are called by neurocommand</li><li>this repo provides a way of using our containers on HPCs for large scale processing of the pipelines (including the support of SLURM and other job schedulers)</li><li>CI: test if exposing of binaries from container works</li></ul><p>Neurocontainers: <a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a></p><ul><li>build scripts for neuro-sub-containers</li><li>CI: building and testing of containers</li><li>CD: pushing containers to github and dockerhub registry</li></ul><p>Neurodocker: <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a></p><ul><li>fork of neurodocker project</li><li>provides recipes for our containers built</li><li>we are providing pull requests back of recipes</li><li>CI: handled by <a href=https://github.com/ReproNim/neurodocker>neurodocker</a> - testing of generating container recipes</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4e0ebcb307acf80f9f0f9d5fcf769e45>2.3 - Neurodesktop Dev</h1><div class=lead>Testing the latest dev version of Neurodesktop</div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>For development and testing only. Not recommended for production use</div><h2 id=building-neurodesktop-dev>Building neurodesktop-dev</h2><p>Dev builds can be triggered by Neurodesk admins from <a href=https://github.com/NeuroDesk/neurodesktop/actions/workflows/build-neurodesktop-dev.yml>https://github.com/NeuroDesk/neurodesktop/actions/workflows/build-neurodesktop-dev.yml</a></p><h2 id=running-latest-neurodesktop-dev>Running latest neurodesktop-dev</h2><h3 id=linux>Linux</h3><pre class="language-shell command-line" data-prompt=$ data-output=3-7>
<code>docker pull vnmd/neurodesktop-dev:latest
sudo docker run \
  --shm-size=1gb -it --cap-add SYS_ADMIN \
  --security-opt apparmor:unconfined --device=/dev/fuse \
  --name neurodesktop-dev \
  -v ~/neurodesktop-storage:/neurodesktop-storage \
  -e HOST_UID="$(id -u)" -e HOST_GID="$(id -g)" \
  -p 8080:8080 -h neurodesktop-dev \
  vnmd/neurodesktop-dev:latest</code>
</pre><h3 id=windows>Windows</h3><pre class="language-batch command-line" data-prompt=">">
<code>docker pull vnmd/neurodesktop-dev:latest
docker run --shm-size=1gb -it --cap-add SYS_ADMIN --security-opt apparmor:unconfined --device=/dev/fuse --name neurodesktop -v C:/neurodesktop-storage:/neurodesktop-storage -p 8080:8080 -h neurodesktop-dev vnmd/neurodesktop-dev:latest</code>
</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-f347e8a68ab88feb2dbd40d7268e3b66>3 - Documentation</h1><div class=lead>How to edit the documentation</div></div><div class=td-content><h1 id=pg-43caa4b2a10189e2fa053496d5d16e07>3.1 - Local Hugo Docsy</h1><div class=lead>How to edit the documentation</div><h2 id=local-hugo-docsy-in-linux-and-wsl2>Local Hugo Docsy in Linux and WSL2</h2><p><a href=https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/CONTRIBUTING.md>https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/CONTRIBUTING.md</a></p><h2 id=local-hugo-docsy-in-windows>Local Hugo Docsy in Windows</h2><h3 id=clone-repository>Clone repository</h3><p>Using SSH</p><p><code>git clone --recurse-submodules git@github.com:NeuroDesk/neurodesk.github.io.git</code></p><p>or Https:</p><p><code>git clone --recurse-submodules https://github.com/NeuroDesk/neurodesk.github.io.git</code></p><h3 id=if-you-cloned-without---recurse-submodules>If you cloned without &ndash;recurse-submodules</h3><p>Run the following command to pull submodules</p><p><code>git submodule update --init --recursive --remote</code></p><h3 id=download-hugo-binary>Download Hugo binary</h3><p>Hugo releases are on <a href=https://github.com/gohugoio/hugo/releases>https://github.com/gohugoio/hugo/releases</a></p><p>Download latest version of hugo extended</p><p>e.g. for windows: <a href=https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_extended_0.88.1_Windows-64bit.zip>https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_extended_0.88.1_Windows-64bit.zip</a></p><h3 id=start-local-hugo-server>Start local hugo server</h3><p>Extract hugo binary (hugo.exe) to your neurodesk.github.io dir</p><p>Run server for windows: <code>.\hugo.exe server --disableFastRender</code></p><p>Once started, dev website will be accessible via http://localhost:1313</p><h3 id=update-docsy-theme-submodule>Update docsy theme submodule</h3><pre class="language-shell command-line" data-prompt=$><code>git submodule update --remote
git add themes/
git commit -m "Updating theme submodule"
git push origin hugo-docsy</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-fd28a1b5010f2ff02bb480802674fb39>4 - How to add new tools</h1><div class=lead>How to add new tools to neurodesk</div></div><div class=td-content><h1 id=pg-c122ef84d9e99678ee0fc712da87cffa>4.1 - Get Neurodesk code</h1><div class=lead>Clone neurocontainer code</div><h1 id=get-neurocontainers-code>Get Neurocontainers code</h1><p>Neurocontainers uses a <strong>forked-repo</strong> and <strong><a href=https://git-scm.com/book/en/v2/Git-Branching-Rebasing>rebase</a>-oriented
workflow</strong>. This means that all contributors create a fork of the <a href=https://github.com/NeuroDesk/neurocontainers/>neurocontainer
repository</a> they want to contribute to and then submit pull
requests to the upstream repository to have their contributions reviewed and
accepted. We also recommend you work on feature branches.</p><h2 id=step-1a-create-your-fork>Step 1a: Create your fork</h2><p>The following steps you&rsquo;ll only need to do the first time you set up a machine
for contributing to Neurocontainers. You&rsquo;ll need to repeat the steps for
any additional NeuroDesk projects (<a href=https://github.com/NeuroDesk/>list</a>) that you work on.</p><p>The first thing you&rsquo;ll want to do to contribute to NeuroDesk is fork (<a href=https://help.github.com/en/articles/fork-a-repo>see
how</a>) the appropriate <a href=https://github.com/NeuroDesk/>NeuroDesk repository</a>.</p><h2 id=step-1b-clone-to-your-machine>Step 1b: Clone to your machine</h2><p>Next, clone your fork to your local machine:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git clone --config pull.rebase https://github.com/YOUR_USERNAME/neurocontainers.git
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Cloning into &#39;neurocontainers&#39;...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Enumerating objects: 6730, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Counting objects: 100% (504/504), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Compressing objects: 100% (229/229), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Total 6730 (delta 308), reused 423 (delta 269), pack-reused 6226
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Receiving objects: 100% (6730/6730), 1.67 MiB | 196.00 KiB/s, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Resolving deltas: 100% (4222/4222), done.
</span></span></span></code></pre></div><p>(The <code>--config pull.rebase</code> option configures Git so that <code>git pull</code>
will behave like <code>git pull --rebase</code> by default. Using
<code>git pull --rebase</code> to update your changes to resolve merge conflicts
is expected by essentially all of open source projects. You can also set that option after cloning using
<code>git config --add pull.rebase true</code>, or just be careful to always run
<code>git pull --rebase</code>, never <code>git pull</code>).</p><p>Note: If you receive an error while cloning, you may not have <a href=https://help.github.com/en/articles/adding-a-new-ssh-key-to-your-github-account>added your ssh
key to GitHub</a>.</p><h2 id=step-1c-connect-your-fork-to-neurocontainers-upstream>Step 1c: Connect your fork to Neurocontainers upstream</h2><p>Next you&rsquo;ll want to <a href=https://help.github.com/en/articles/configuring-a-remote-for-a-fork>configure an upstream remote
repository</a> for your fork of Neurocontainers. This will allow
you to <a href=https://help.github.com/en/articles/syncing-a-fork>sync changes</a> from the main project back into
your fork.</p><p>First, show the currently configured remote repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git remote -v
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>origin  git@github.com:YOUR_USERNAME/neurocontainers.git (fetch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>origin  git@github.com:YOUR_USERNAME/neurocontainers.git (push)
</span></span></span></code></pre></div><p>Note: If you&rsquo;ve cloned the repository using Github GUI, you may already
have the upstream remote repository configured. For example, when you clone
<a href=https://github.com/NeuroDesk/neurocontainers/>NeuroDesk/neurocontainers</a> with the GitHub desktop client it configures the remote repository <code>neurocontainer</code> and you see the following output from
<code>git remote -v</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>origin  git@github.com:YOUR_USERNAME/neurocontainer.git (fetch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>origin  git@github.com:YOUR_USERNAME/neurocontainer.git (push)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>neurocontainers	https://github.com/NeuroDesk/neurocontainers.git (fetch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>neurocontainers	https://github.com/NeuroDesk/neurocontainers.git (push)
</span></span></span></code></pre></div><p>If your client hasn&rsquo;t automatically configured a remote for NeuroDesk/eurocontainers, you&rsquo;ll need to with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git remote add -f upstream https://github.com/NeuroDesk/neurocontainers.git
</span></span></code></pre></div><p>Finally, confirm that the new remote repository, upstream, has been configured:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git remote -v
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>origin	https://github.com/YOUR_USERNAME/neurocontainers.git (fetch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>origin	https://github.com/YOUR_USERNAME/neurocontainers.git (push)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>upstream	https://github.com/NeuroDesk/neurocontainers.git (fetch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>upstream	https://github.com/NeuroDesk/neurocontainers.git (push)
</span></span></span></code></pre></div><h2 id=step-2-set-up-the-neurocontainers-development-environment>Step 2: Set up the Neurocontainers development environment</h2><p>If you haven&rsquo;t already, now is a good time to install the Neurocontainers development environment
(<a href=https://www.neurodesk.org/developers/new_tools/add_tool/>Add tools</a>).</p><h2 id=step-3-configure-continuous-integration-for-your-fork>Step 3: Configure continuous integration for your fork</h2><p>This step is optional, but recommended.</p><ol><li>Go to your neurocontainers fork.</li><li>If Actions tab is missing, go to Settings > Actions. Select Allow all actions. Then Save.</li><li>In the actions tab, select “I understand my workflows, go ahead and enable them”</li></ol><p>Neurocontainers is configured to use <a href=https://docs.github.com/en/actions>GitHub Actions</a>
to test and create builds upon each new commit and pull request.
GitHub Actions is the primary CI that runs frontend and backend
tests across a wide range of Ubuntu distributions.</p><p>GitHub Actions is free for open source projects and it&rsquo;s easy to
configure for your own fork of neurocontainer. After doing so, GitHub Actions
will run tests for new refs you push to GitHub and email you the outcome
(you can also view the results in the web interface).</p><p>Running CI against your fork can help save both your and the
NeuroDesk maintainers time by making it easy to test a change fully before
submitting a pull request. We generally recommend a workflow where as
you make changes, you use a fast edit-refresh cycle running individual
tests locally until your changes work. But then once you&rsquo;ve gotten
the tests you&rsquo;d expect to be relevant to your changes working, push a
branch to run the full test suite in GitHub Actions before
you create a pull request. While you wait for GitHub Actions jobs
to run, you can start working on your next task. When the tests finish,
you can create a pull request that you already know passes the tests.</p><p>GitHub Actions will run all the jobs by default on your forked repository.
You can check the <code>Actions</code> tab of your repository to see the builds.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd6045c57eea320a927f9a85200b8697>4.2 - Using Git</h1><div class=lead>Contribution workflow using Git</div><h1 id=working-copies>Working copies</h1><p>When you work on Neurocontainers code, there are three copies of the Neurocontainers Git
repository that you are generally concerned with:</p><ul><li>The <code>upstream</code> remote. This is the <a href=https://github.com/NeuroDesk/neurocontainers>official Neurocontainers
repository</a> on GitHub. You probably
don&rsquo;t have write access to this repository.</li><li>The <strong>origin</strong> remote: Your personal remote repository on GitHub.
You&rsquo;ll use this to share your code and create <a href=../pull_request>pull requests</a>.</li><li>local copy: This lives on your laptop or your remote dev instance,
and is what you&rsquo;ll use to make changes and create commits.</li></ul><p>When you work on Neurocontainers code, you will end up moving code between
the various working copies.</p><h2 id=workflows>Workflows</h2><p>Sometimes you need to get commits. Here are some scenarios:</p><ul><li>You may fork the official Neurocontainers repository to your GitHub fork.</li><li>You may fetch commits from the official Neurocontainers repository to your local copy.</li><li>You occasionally may fetch commits from your forked copy.</li></ul><p>Sometimes you want to publish commits. Here are some scenarios:</p><ul><li>You push code from your local copy to your GitHub fork. (You usually
want to put the commit on a feature branch.)</li><li>You submit a PR to the official Neurocontainers repo.</li></ul><p>Finally, the NeuroDesk core team will occasionally want your changes!</p><ul><li>The NeuroDesk core team can accept your changes and add them to
the official repo, usually on the <code>master</code> branch.</li></ul><h2 id=relevant-git-commands>Relevant Git commands</h2><p>The following commands are useful for moving commits between
working copies:</p><ul><li><code>git fetch</code>: This grabs code from another repository to your local
copy. (Defaults to fetching from your default remote, <code>origin</code>).</li><li><code>git fetch upstream</code>: This grabs code from the upstream repository to your local copy.</li><li><code>git push</code>: This pushes code from your local repository to one of the remotes.</li><li><code>git remote</code>: This helps you configure short names for remotes.</li><li><code>git pull</code>: This pulls code, but by default creates a merge commit
(which you definitely don&rsquo;t want). However, if you&rsquo;ve followed our
<a href=../cloning>cloning documentation</a>, this will do
<code>git pull --rebase</code> instead, which is the only mode you&rsquo;ll want to
use when working on Neurodesk.</li></ul><h2 id=know-what-branch-youre-working-on>Know what branch you&rsquo;re working on</h2><p>When using Git, it&rsquo;s important to know which branch you currently have checked
out because most Git commands implicitly operate on the current branch. You can
determine the currently checked out branch several ways.</p><p>One way is with <a href=https://git-scm.com/docs/git-status>git status</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git status
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch newapp
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>nothing to commit, working directory clean
</span></span></span></code></pre></div><p>Another is with <a href=https://git-scm.com/docs/git-branch>git branch</a> which will display all local
branches, with a star next to the current branch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git branch
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* newapp
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  master
</span></span></span></code></pre></div><p>To see even more information about your branches, including remote branches,
use <code>git branch -vva</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git branch -vva
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* civet_2.1.1                             f736814 [origin/civet_2.1.1] set DEPLOY_PATH
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  master                                  a0f0455 [origin/master] Merge pull request #129
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  remotes/origin/cat12_with_neurodocker   763f6de works :)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  remotes/origin/civet_2.1.1              f736814 set DEPLOY_PATH
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  remotes/origin/master                   a0f0455 Merge pull request #129
</span></span></span></code></pre></div><p>You can also configure <a href=https://git-scm.com/book/en/v2/Git-in-Other-Environments-Git-in-Bash>Bash</a> and
<a href=https://git-scm.com/book/en/v2/Git-in-Other-Environments-Git-in-Zsh>Zsh</a> to display the current branch in your prompt.</p><h2 id=keep-your-fork-up-to-date>Keep your fork up to date</h2><p>You&rsquo;ll want to <a href=https://help.github.com/en/articles/syncing-a-fork>keep your fork</a> up-to-date with changes
from Neurocontainers&rsquo;s master repositories.</p><p><strong>Note about <code>git pull</code></strong>: Rather than using <code>git pull</code>, which by default is a shortcut for <code>git fetch && git merge FETCH_HEAD</code> (<a href=https://git-scm.com/docs/git-pull>docs</a>), you
should use <code>git pull --rebase</code>, which is like <code>git fetch</code> and then <code>git rebase</code>.</p><p>First, <a href=https://git-scm.com/docs/git-fetch>fetch</a> changes from Neurocontainers&rsquo;s upstream repository you
configured in the step above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git fetch upstream
</span></span></code></pre></div><p>Next, check out your <code>master</code> branch and <a href=https://git-scm.com/docs/git-rebase>rebase</a> it on top
of <code>upstream/master</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout master
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to branch &#39;master&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git rebase upstream/master
</span></span></code></pre></div><p>This will rollback any changes you&rsquo;ve made to <code>master</code>, update it from
<code>upstream/master</code>, and then re-apply your changes. Rebasing keeps the commit
history clean and readable.</p><p>When you&rsquo;re ready, <a href=https://help.github.com/en/articles/pushing-to-a-remote>push your changes</a> to your remote fork.
Make sure you&rsquo;re in branch <code>master</code> and then run <code>git push</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout master
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin master
</span></span></code></pre></div><p>You can keep any branch up to date using this method. If you&rsquo;re working on a
feature branch (see next section), which we recommend, you would change the
command slightly, using the name of your <code>feature-branch</code> rather than <code>master</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout feature-branch
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to branch &#39;feature-branch&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git rebase upstream/master
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git push origin feature-branch
</span></span></code></pre></div><h2 id=work-on-a-feature-branch>Work on a feature branch</h2><p>One way to keep your work organized is to create a branch for each issue or
feature. You can and should create as many branches as you&rsquo;d like.</p><p>First, make sure your <code>master</code> branch is up-to-date with Neurocontainers upstream (<a href=#keep-your-fork-up-to-date>see
how</a>).</p><p>Next, from your <code>master</code> branch, create a new tracking branch, providing a
descriptive name for your feature branch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout master
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to branch &#39;master&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git checkout -b issue-1755-fail2ban
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to a new branch &#39;issue-1755-fail2ban&#39;
</span></span></span></code></pre></div><p>Alternatively, you can create a new branch explicitly based off
<code>upstream/master</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout -b issue-1755-fail2ban upstream/master
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to a new branch &#39;issue-1755-fail2ban&#39;
</span></span></span></code></pre></div><p>Now you&rsquo;re ready to work on the issue or feature.</p><h2 id=stage-changes>Stage changes</h2><p>Recall that files tracked with Git have three possible states:
committed, modified, and staged.</p><p>To prepare a commit, first add the files with changes that you want
to include in your commit to your staging area. You <em>add</em> both new files and
existing ones. You can also remove files from staging when necessary.</p><h3 id=get-status-of-working-directory>Get status of working directory</h3><p>To see which files in the working directory have changes that have not been
staged, use <code>git status</code>.</p><p>If you have no changes in the working directory, you&rsquo;ll see something like
this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git status
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-123
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>nothing to commit, working directory clean
</span></span></span></code></pre></div><p>If you have unstaged changes, you&rsquo;ll see something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-123
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Untracked files:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git add &lt;file&gt;...&#34; to include in what will be committed)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        build.sh
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>nothing added to commit but untracked files present (use &#34;git add&#34; to track)
</span></span></span></code></pre></div><h3 id=stage-additions-with-git-add>Stage additions with <code>git add</code></h3><p>To add changes to your staging area, use <code>git add &lt;filename></code>. Because
<code>git add</code> is all about staging the changes you want to commit, you use
it to add <em>new files</em> as well as <em>files with changes</em> to your staging
area.</p><p>Continuing our example from above, after we run <code>git add build.sh</code>, we&rsquo;ll see
the following from <code>git status</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-123
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Changes to be committed:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git reset HEAD &lt;file&gt;...&#34; to unstage)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        new file:   build.sh
</span></span></span></code></pre></div><p>You can view the changes in files you have staged with <code>git diff --cached</code>. To
view changes to files you haven&rsquo;t yet staged, just use <code>git diff</code>.</p><p>If you want to add all changes in the working directory, use <code>git add -A</code>
(<a href=https://git-scm.com/docs/git-add>documentation</a>).</p><p>You can also stage changes using your Github GUI.</p><p>If you stage a file, you can undo it with <code>git reset HEAD &lt;filename></code>. Here&rsquo;s
an example where we stage a file <code>build.sh</code> and then unstage it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git add build.sh
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-1234
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Changes to be committed:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git reset HEAD &lt;file&gt;...&#34; to unstage)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        new file:   build.sh
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git reset HEAD build.sh
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> git status
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-1234
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Untracked files:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git add &lt;file&gt;...&#34; to include in what will be committed)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        build.sh
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>nothing added to commit but untracked files present (use &#34;git add&#34; to track)
</span></span></span></code></pre></div><h3 id=stage-deletions-with-git-rm>Stage deletions with <code>git rm</code></h3><p>To remove existing files from your repository, use <code>git rm</code>
(<a href=https://git-scm.com/docs/git-rm>documentation</a>). This command can either stage the file for
removal from your repository AND delete it from your working directory or just
stage the file for deletion and leave it in your working directory.</p><p>To stage a file for deletion and <strong>remove</strong> it from your working directory, use
<code>git rm &lt;filename></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git rm test.txt
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>rm &#39;test.txt&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git status
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-1234
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Changes to be committed:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git reset HEAD &lt;file&gt;...&#34; to unstage)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        deleted:    test.txt
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> ls test.txt
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>ls: No such file or directory
</span></span></span></code></pre></div><p>To stage a file for deletion and <strong>keep</strong> it in your working directory, use
<code>git rm --cached &lt;filename></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git rm --cached test2.txt
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>rm &#39;test2.txt&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git status
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>On branch issue-1234
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Changes to be committed:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git reset HEAD &lt;file&gt;...&#34; to unstage)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>        deleted:    test2.txt
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> ls test2.txt
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>test2.txt
</span></span></span></code></pre></div><p>If you stage a file for deletion with the <code>--cached</code> option, and haven&rsquo;t yet
run <code>git commit</code>, you can undo it with <code>git reset HEAD &lt;filename></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reset HEAD test2.txt
</span></span></code></pre></div><p>Unfortunately, you can&rsquo;t restore a file deleted with <code>git rm</code> if you didn&rsquo;t use
the <code>--cache</code> option. However, <code>git rm</code> only deletes files it knows about.
Files you have never added to Git won&rsquo;t be deleted.</p><h2 id=commit-changes>Commit changes</h2><p>When you&rsquo;ve staged all your changes, you&rsquo;re ready to commit. You can do this
with <code>git commit -m "My commit message."</code> to include a commit message.</p><p>Here&rsquo;s an example of committing with the <code>-m</code> for a one-line commit message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git commit -m <span style=color:#4e9a06>&#34;Add a test commit for docs.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>[issue-123 173e17a] Add a test commit for docs.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> 1 file changed, 1 insertion(+)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> create mode 100644 newfile.py
</span></span></span></code></pre></div><p>You can also use <code>git commit</code> without the <code>-m</code> option and your editor to open,
allowing you to easily draft a multi-line commit message.</p><p>How long your commit message should be depends on where you are in your work.
Using short, one-line messages for commits related to in-progress work makes
sense. For a commit that you intend to be final or that encompasses a
significant amount or complex work, you should include a longer message.</p><p>Keep in mind that your commit should contain a &lsquo;minimal coherent idea&rsquo; and have
a quality commit message.</p><p>Here&rsquo;s an example of a longer commit message that will be used for a pull request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Add CIVET 2.1.1 container.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Edit build.sh and README.md to build container for CIVET 2.1.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Tested on my local Ubuntu development server, but need to test within Neurodesktop.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Fixes #1755.
</span></span></code></pre></div><p>The first line is the summary. The following paragraphs are full prose and
explain why and how the change was made. It explains what testing was done
and asks specifically for further testing. The final paragraph indicates
that this commit addresses and fixes issue #1755.
When you submit your pull request, GitHub will detect and link this reference
to the appropriate issue. Once your commit is merged into <code>upstream/master</code>, GitHub
will automatically close the referenced issue. See <a href=https://help.github.com/en/articles/closing-issues-via-commit-messages>Closing issues via commit
messages</a> for details.</p><p>Note in particular that GitHub&rsquo;s regular expressions for this feature
are sloppy, so phrases like <code>Partially fixes #1234</code> will automatically
close the issue. Phrases like <code>Fixes part of #1234</code> are a good
alternative.</p><p>Make as many commits as you need to address the issue or implement your feature.</p><h2 id=push-your-commits-to-github>Push your commits to GitHub</h2><p>As you&rsquo;re working, it&rsquo;s a good idea to frequently push your changes to GitHub.
This ensures your work is backed up should something happen to your local
machine and allows others to follow your progress. It also allows you to
<a href=../troubleshooting#working-from-multiple-computers>work from multiple computers</a> without losing work.</p><p>Pushing to a feature branch is just like pushing to <code>master</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin &lt;branch-name&gt;
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Counting objects: 6, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Delta compression using up to 4 threads.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Compressing objects: 100% (4/4), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Writing objects: 100% (6/6), 658 bytes | 0 bytes/s, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Total 6 (delta 3), reused 0 (delta 0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Resolving deltas: 100% (3/3), completed with 1 local objects.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To git@github.com:christi3k/neurocontainers.git
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> * [new branch]      issue-demo -&gt; issue-demo
</span></span></span></code></pre></div><p>If you want to see what Git will do without actually performing the push, add
the <code>-n</code> (dry-run) option: <code>git push -n origin &lt;branch-name></code>. If everything
looks good, re-run the push command without <code>-n</code>.</p><p>If the feature branch does not already exist on GitHub, it will be created when
you push and you&rsquo;ll see <code>* [new branch]</code> in the command output.</p><h2 id=examine-and-tidy-your-commit-history>Examine and tidy your commit history</h2><p>Examining your commit history prior to submitting your pull request is a good
idea. Will the person reviewing your commit history be able to clearly understand
your progression of work?</p><p>On the command line, you can use the <code>git log</code> command to display an easy to
read list of your commits:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git log --all --graph --oneline --decorate
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>* 4f8d75d (HEAD -&gt; 1754-docs-add-git-workflow) docs: Add details about configuring Travis CI.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* bfb2433 (origin/1754-docs-add-git-workflow) docs: Add section for keeping fork up-to-date to Git Guide.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* 4fe10f8 docs: Add sections for creating and configuring fork to Git Guide.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* 985116b docs: Add graphic client recs to Git Guide.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* 3c40103 docs: Add stubs for remaining Git Guide sections.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* fc2c01e docs: Add git guide quickstart.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>| * f0eaee6 (upstream/master) bug: Fix traceback in get_missed_message_token_from_address().
</span></span></span></code></pre></div><p>Alternatively, use your graphical client to view the history for your feature branch.</p><p>If you need to update any of your commits, you can do so with an interactive
<a href=https://help.github.com/en/articles/using-git-rebase>rebase</a>. Common reasons to use an interactive rebase
include:</p><ul><li>squashing several commits into fewer commits</li><li>splitting a single commit into two or more</li><li>rewriting one or more commit messages</li></ul><p>There is ample documentation on how to rebase, so we won&rsquo;t go into details
here. We recommend starting with GitHub&rsquo;s help article on
<a href=https://help.github.com/en/articles/using-git-rebase>rebasing</a> and then consulting Git&rsquo;s documentation for
<a href=https://git-scm.com/docs/git-rebase>git-rebase</a> if you need more details.</p><p>If all you need to do is edit the commit message for your last commit, you can
do that with <code>git commit --amend</code>. See <a href=https://git-scm.com/book/en/v2/Git-Basics-Undoing-Things>Git Basics - Undoing
Things</a> for details on this and other useful commands.</p><h2 id=force-push-changes-to-github-after-youve-altered-your-history>Force-push changes to GitHub after you&rsquo;ve altered your history</h2><p>Any time you alter history for commits you have already pushed to GitHub,
you&rsquo;ll need to prefix the name of your branch with a <code>+</code>. Without this, your
updates will be rejected with a message such as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin 1754-docs-add-git-workflow
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To git@github.com:christi3k/neurocontainers.git
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> ! [rejected] 1754-docs-add-git-workflow -&gt; 1754-docs-add-git-workflow (non-fast-forward)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>error: failed to push some refs to &#39;git@github.com:christi3k/neurocontainers.git&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>hint: Updates were rejected because the tip of your current branch is behind
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>hint: its remote counterpart. Integrate the remote changes (e.g.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>hint: &#39;git pull ...&#39;) before pushing again.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.
</span></span></span></code></pre></div><p>Re-running the command with <code>+&lt;branch></code> allows the push to continue by
re-writing the history for the remote repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin +1754-docs-add-git-workflow
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Counting objects: 12, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Delta compression using up to 4 threads.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Compressing objects: 100% (12/12), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Writing objects: 100% (12/12), 3.71 KiB | 0 bytes/s, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Total 12 (delta 8), reused 0 (delta 0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Resolving deltas: 100% (8/8), completed with 2 local objects.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To git@github.com:christi3k/neurocontainers.git
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> + 2d49e2d...bfb2433 1754-docs-add-git-workflow -&gt; 1754-docs-add-git-workflow (forced update)
</span></span></span></code></pre></div><p>This is perfectly okay to do on your own feature branches, especially if you&rsquo;re
the only one making changes to the branch. If others are working along with
you, they might run into complications when they retrieve your changes because
anyone who has based their changes off a branch you rebase will have to do a
complicated rebase.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e24a02244ddbf4a83fcf0095e3003590>4.3 - Add tools</h1><div class=lead>Add a tool to neurodesktop</div><p>The goal of <em>neurodesk</em> is to provide users with a large choice of tools to use in their pipelines.
Use the guide below to add a tool to <em>neurodesktop</em> or <em>neurocontainers</em>.</p><h2 id=guiding-principles>Guiding principles</h2><p>To decide if a tool should be packaged in a singularity container in <em>neurocontainers</em> or be installed in the <em>neurodesktop</em> container we are currently following these guiding principles:</p><ol><li><em>neurodesk</em> is not a package manager. This means we are not distributing tools in containers that can easily be installed via a standard package manager</li><li><em>neurodesk</em> allows users to have multiple versions of tools in parallel via <a href=https://lmod.readthedocs.io/en/latest/>lmod</a>, this means that if different versions of a tool can&rsquo;t be installed in parallel we package the tool inside a container.</li><li><em>neurodesk</em> aims to provide tooling to link tools from different containers (such as workflow managers like nipype or nextflow). This means that if a tool is required to coordinate various container-tools, it should be in the <em>neurodesktop</em> container.</li></ol><p>Examples:</p><table><thead><tr><th></th><th>easy install</th><th>coordinates containers</th><th>small in size</th><th>latest version is ok</th><th>useful to most users</th><th>Conclusion</th></tr></thead><tbody><tr><td>git</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>neurodesktop</td></tr><tr><td>lmod</td><td>no</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>neurodesktop</td></tr><tr><td>nipype</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>neurodesktop</td></tr><tr><td>vscode</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>yes</td><td>neurodesktop</td></tr><tr><td>itksnap</td><td>yes</td><td>no</td><td>yes</td><td>yes</td><td>yes</td><td>container?</td></tr><tr><td>convert3D</td><td>yes</td><td>no</td><td>yes</td><td>no</td><td>no</td><td>container</td></tr><tr><td>fsl</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td><td>container</td></tr><tr><td>mrtrix</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td><td>container</td></tr><tr><td>freesurfer</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td><td>container</td></tr></tbody></table><h2 id=adding-new-recipes>Adding new recipes</h2><p>Refer to <a href=https://github.com/NeuroDesk/neurodocker>neurodocker</a> for more information on neurodocker recipes</p><h2 id=build-container>Build container</h2><h3 id=environment-requirements>Environment Requirements</h3><ul><li>Docker</li><li>Recent Python Version<br>Search for &ldquo;python_requires&rdquo; in <a href=https://github.com/NeuroDesk/neurodocker/blob/master/setup.cfg>https://github.com/NeuroDesk/neurodocker/blob/master/setup.cfg</a> for minimal version of Python required. If you have several versions of Python installed in the environment, typing &lsquo;python&rsquo; in the terminal should launch a version with equal or higher version number</li><li>Python pip3<br>This should be launched by &lsquo;python -m pip&rsquo;</li><li>git</li></ul><h3 id=install-neurodocker>Install Neurodocker</h3><p>Neurodocker is the dependency we use to build containers.</p><ol><li>(optional) Sync upstream repository:<br>If you have the permissions to do so: Press &ldquo;Fetch upstream&rdquo; in <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a> to check if our fork of Neurodocker is already up-to-date. Otherwise, open an issue in <a href=https://github.com/NeuroDesk/neurocontainers/issues>https://github.com/NeuroDesk/neurocontainers/issues</a>, requesting to pull-in latest changes from Neurodocker upstream into our fork of Neurodocker. One of the admins will attend the issue and perform the operation.</li><li>(optional) Add a new neurodocker tool:<br>If relevant to your project, add an option to neurodocker that installs new software (<a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a>) and create a pull request to neurodocker&rsquo;s main responsitory (add new tool in a branch!).</li><li>Clone our fork of Neurodocker:<pre class="language-shell command-line" data-prompt=$><code>git clone https://github.com/NeuroDesk/neurodocker/</code></pre></li><li>Install neurodocker:<pre class="language-shell command-line" data-prompt=$><code>cd neurodocker  
python -m pip install .
cd ..</code></pre></li><li>Run:
echo &rsquo;export PATH=${PATH}:${HOME}/.local/bin&rsquo; &#187; ${HOME}/.bashrc</li><li>Close the terminal, and reopen it for the updated PATH to take effect</li></ol><h3 id=clone-the-neurocontainers-repository>Clone the Neurocontainers repository</h3><ul><li><p><em>Option A</em>) Fork neurocontainers and setup github actions:<br>Follow the steps in <a href=https://www.neurodesk.org/developers/new_tools/cloning/>Get Neurodesk code</a>.</p></li><li><p><em>Option B</em>) Clone from NeuroDesk:</p><pre class="language-shell command-line" data-prompt=$><code>git clone https://github.com/NeuroDesk/neurocontainers/</code></pre></li></ul><h3 id=create-a-new-app>Create a new app</h3><ol><li><p>Copy the directory template and rename to <em>newapp</em> in <code>neurocontainers/recipes</code>:</p><pre class="language-shell command-line" data-prompt=$><code>cd neurocontainers/recipes
cp -R template newapp</code></pre></li><li><p>Create your Container Files:<br>Modify <code>build.sh</code> in <code>neurocontainers/recipes/newapp</code> to build your application and update <code>README.md</code> (make sure the version is correct in the README!). Notice that the example build script in the template has instructions to build a conatiner for datalad, that may or may not suite your exact needs</p><pre class="language-shell command-line" data-prompt=$ data-output=2-3><code>cd newapp
(edit build.sh as required)
(edit README.md as required)</code></pre><p>Upload your application to object storage first if needed, so you can then download it in <code>build.sh</code> (ask for instructions about this if you don&rsquo;t know the key, and never share it anywhere public!)</p></li><li><p>Run <code>update-builders.sh</code>:
This will auto-create the CI workflow for the application (or manually duplicate the template file and rename all occurances of template to <em>newapp</em>)</p><pre class="language-shell command-line" data-prompt=$><code>cd ../..
sh update-builders.sh</code></pre><div class="alert alert-primary" role=alert>If the CI build runs out of space, add the application to the following txt file to add additional space:
<a href=https://github.com/NeuroDesk/neurocontainers/blob/master/.github/workflows/free-up-space-list.txt>https://github.com/NeuroDesk/neurocontainers/blob/master/.github/workflows/free-up-space-list.txt</a>.
Note: this increases CI run time, only use in cases of out-of-space errors.</div></li><li><p>Build and test the container locally</p><ol><li><p>run the build script with the debug flag:</p><pre class="language-shell command-line" data-prompt=$><code>cd recipes/newapp
chmod +x build.sh
./build.sh -ds</code></pre></li><li><p>test running some commands within the container that should be available in your local docker container repository.</p><p>For example, to open an interactive shell in a container (with the home folder /root binded to /root on host), you may run:</p><pre class="language-shell command-line" data-prompt=$><code>sudo docker run -it -v /root:/root --entrypoint /bin/bash NEWAPP_VERSION:TAG
</code></pre><p>with VERSION being the version of the app, and TAG the version tag of the container (run &lsquo;sudo docker image list&rsquo; to find the tag)</p></li><li><p>if your application requires a Matlab Runtime and you get an error about shared library &ldquo;libmwlaunchermain.so&rdquo; not found, check which version of the runtime was installed by the build script</p></li></ol></li><li><p>Update changes in local git repository</p><pre class="language-shell command-line" data-prompt=$><code>git add recipes/newapp/build.sh recipes/newapp/README.md .github/workflows/newapp.yml
git config user.email "the email that you use for github"
git config user.name "your name"
git commit</code></pre></li></ol><h3 id=push-the-new-app-to-neurocontainers>Push the new app to Neurocontainers</h3><p><strong>Prerequisite</strong></p><p>Generate git personal access token (if you don’t have one already)</p><ol><li>Browse to <a href=https://github.com/>https://github.com/</a></li><li>Log into your account</li><li>Press on your picture in upper right corner &ndash;> Setting &ndash;> Developer Settings &ndash;> Personal Access Token</li><li>Press on “generate personal access token”</li><li>Write something in “Notes” (doesn’t matter what, it’s for your own use)</li><li>Check “repo”</li><li>Check “Workflow”</li><li>Press “Generate Token” at the bottom</li><li>Copy the token displayed to somewhere safe, as you will have to user it later</li></ol><p><strong>Step by step guide</strong></p><ol><li><p>Test the container locally, and if successful push repo to trigger the automatic build on GitHub. When asked for your Github password, please provide the personal access token obtained in the previous stage.</p><pre class="language-shell command-line" data-prompt=$><code>git pull
git push</code></pre></li><li><p>Go to <a href=https://github.com/neurodesk/neurocontainers/actions>https://github.com/neurodesk/neurocontainers/actions</a>. Check that the most recent workflow run in the list terminated successfully (green). Otherwise, click on it, click on “build docker”, and the line that caused the error will be highlighted</p></li><li><p>Find your new package under <a href="https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers">https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers</a><br>Enter the name of the package in the search box, and verify that the full package name shows up in the format <em>toolName_toolVersion</em></p></li><li><p>Obtain <em>buildDate</em> by clicking on the full package name that came up in the search. The build date will be the newest date shown under <strong>Recent tagged image versions</strong></p></li><li><p>Use <em>toolName</em>, <em>toolVersion</em> and <em>buildDate</em> from the previous two steps to manually download the package by typing the following in a terminal open in Neurodesktop</p><pre class="language-shell command-line" data-prompt=$><code>bash /neurocommand/local/fetch_and_run.sh toolName toolVersion buildDate
   (when you see the "Singularity>" prompt, type exit and ENTER)
 ml toolName/toolVersion</code></pre><p>For example:
If the full package name that comes up in the step 11 is itksnap_3.8.0, and the newest date under <strong>Recent tagged image versions</strong> is 20210322</p><p>The command to use in a terminal open in Neurodesktop is:</p><pre class="language-shell command-line" data-prompt=$><code>bash /neurocommand/local/fetch_and_run.sh itksnap 3.8.0 20210322
  (when you see the "Singularity>" prompt, type exit and ENTER)
 module use /neurodesktop-storage/containers/modules
 ml toolName/toolVersion</code></pre></li></ol><div class="alert alert-warning" role=alert><h4 class=alert-heading>Depreciation notice</h4><p>For VNM users use:</p><pre class="language-shell command-line" data-prompt=$><code>bash /neurodesk/local/fetch_and_run.sh toolName toolVersion buildDate
  ml toolName/toolVersion</code></pre></div><ol start=6><li><p>Test the new container. Run some commands, to see all is good<br>If the container doesn&rsquo;t work yet, it&rsquo;s sometimes useful to try and troubleshoot it and install missing libraries. This can be achieved by running it in a writable mode with fakeroot enabled:</p><pre class="language-shell command-line" data-prompt=$><code>SINGULARITY_BINDPATH=''; singularity shell --writable --fakeroot /neurodesktop-storage/containers/toolName_toolVersion_buildDate/toolName_toolVersion_buildDate.simg</code></pre></li><li><p>Fork <a href=https://github.com/NeuroDesk/neurocommand/>https://github.com/NeuroDesk/neurocommand/</a> to your Github account</p></li><li><p>Edit an entry for your package in your fork of <code>neurocommand/blob/main/neurodesk/apps.json</code> based on one of the other entries (generating one menu item for opening a terminal inside the containers, and one menu item for the GUI, if relevant). Notice that in the json file, the version field should contain the <em>buildDate</em></p></li><li><p>Include an icon file in your fork of neurocommand/neurodesk/icons</p></li><li><p>Send a pull request from your fork of neurocommand to <a href=https://github.com/NeuroDesk/neurocommand/>https://github.com/NeuroDesk/neurocommand/</a></p></li><li><p>When the pull request is merged by Neurodesk admins, it will trigger an action to build the singularity container, distribute it in all object storage locations and on CVMFS, and it will update the menus in the desktop image on the next daily build.</p></li><li><p>Wait at least 24 hours</p></li><li><p>Download and run the daily build of neurodesktop to check that your app can be launched from the start menu and works properly:</p><pre class="language-shell command-line" data-prompt=$><code>sudo docker pull vnmd/neurodesktop:latest && sudo docker run   --shm-size=1gb -it --privileged --name neurodesktop   -v ~/neurodesktop-storage:/neurodesktop-storage   -e HOST_UID="$(id -u)" -e HOST_GID="$(id -g)"   -p 8080:8080 -h neurodesktop-latest   vnmd/neurodesktop:latest</code></pre></li><li><p>Open an issue in <a href=https://github.com/NeuroDesk/neurocontainers/issues>https://github.com/NeuroDesk/neurocontainers/issues</a> notifying that your app appears in the start menu and tested. The app will be included in the next release of Neurodesktop, and will be mentioned in the public announcement that accompanies the release. If the app is not in the start menu or not working as expected based on your earlier testing, open an issue as well, and report it.</p></li><li><p>If somebody wants to use the application before the next release of Neurodesktop is out, you can instruct them to use the command in step 13 above instead of the deafult commands given in the user install instructions.</p></li><li><p>Consider contributing a tutorial about the new tool: <a href=https://github.com/NeuroDesk/neurodesk.github.io/tree/hugo-docsy/content/en/tutorials>https://github.com/NeuroDesk/neurodesk.github.io/tree/hugo-docsy/content/en/tutorials</a></p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-d8e9695a04ad28c1d14505b5b444f9cb>4.4 - Fix commit</h1><div class=lead>Fix commit</div><h2 id=fixing-the-last-commit>Fixing the last commit</h2><h3 id=changing-the-last-commit-message>Changing the last commit message</h3><ol><li><code>git commit --amend -m "New message"</code></li></ol><h3 id=changing-the-last-commit>Changing the last commit</h3><ol><li>Make your changes to the files</li><li>Run <code>git add &lt;filename></code> to add one file or <code>git add &lt;filename1> &lt;filename2> ...</code> to add multiple files</li><li><code>git commit --amend</code></li></ol><h2 id=fixing-older-commits>Fixing older commits</h2><h3 id=changing-commit-messages>Changing commit messages</h3><ol><li><code>git rebase -i HEAD~5</code> (if, for example, you are editing some of the last five commits)</li><li>For each commit that you want to change the message, change <code>pick</code> to <code>reword</code>, and save</li><li>Change the commit messages</li></ol><h3 id=deleting-old-commits>Deleting old commits</h3><ol><li><code>git rebase -i HEAD~n</code> where <code>n</code> is the number of commits you are looking at</li><li>For each commit that you want to delete, change <code>pick</code> to <code>drop</code>, and save</li></ol><h2 id=squashing-commits>Squashing commits</h2><p>Sometimes, you want to make one commit out of a bunch of commits. To do this,</p><ol><li><code>git rebase -i HEAD~n</code> where <code>n</code> is the number of commits you are interested in</li><li>Change <code>pick</code> to <code>squash</code> on the lines containing the commits you want to squash and save</li></ol><h2 id=reordering-commits>Reordering commits</h2><ol><li><code>git rebase -i HEAD~n</code> where <code>n</code> is the number of commits you are interested in</li><li>Reorder the lines containing the commits and save</li></ol><h2 id=pushing-commits-after-tidying-them>Pushing commits after tidying them</h2><ol><li><code>git push origin +my-feature-branch</code> (Note the <code>+</code> there and substitute your actual branch name.)</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-d633e953d580caca810a21667c2cd386>4.5 - Create a pull request</h1><div class=lead>Pull request and make contribution</div><h1 id=create-a-pull-request>Create a pull request</h1><p>When you&rsquo;re ready for feedback, submit a pull request. Pull requests
are a feature specific to GitHub. They provide a simple, web-based way
to submit your work (often called &ldquo;patches&rdquo;) to a project. It&rsquo;s called
a <em>pull request</em> because you&rsquo;re asking the project to <em>pull changes</em>
from your fork.</p><p>If you&rsquo;re unfamiliar with how to create a pull request, you can check
out GitHub&rsquo;s documentation on
<a href=https://help.github.com/en/articles/creating-a-pull-request-from-a-fork>creating a pull request from a fork</a>. You
might also find GitHub&rsquo;s article
<a href=https://help.github.com/en/articles/about-pull-requests>about pull requests</a> helpful. That all said,
the tutorial below will walk you through the process.</p><h2 id=create-a-pull-request-1>Create a pull request</h2><h3 id=step-0-make-sure-youre-on-a-feature-branch-not-master>Step 0: Make sure you&rsquo;re on a feature branch (not <code>master</code>)</h3><p>It is important to <a href=../workflow#work-on-a-feature-branch>work on feature branch</a> when creating a pull
request. Your new pull request will be inextricably linked with your
branch while it is open, so you will need to reserve your branch only
for changes related to your issue, and avoid introducing extraneous
changes for other issues or from upstream.</p><p>If you are working on a branch named <code>master</code>, you need to create and
switch to a feature branch before proceeding.</p><h3 id=step-1-update-your-branch-with-git-rebase>Step 1: Update your branch with git rebase</h3><p>The best way to update your branch is with <code>git fetch</code> and <code>git rebase</code>. Do not
use <code>git pull</code> or <code>git merge</code> as this will create merge commits. See <a href=../workflow#keep-your-fork-up-to-date>keep your
fork up to date</a> for details.</p><p>Here&rsquo;s an example (you would replace <em>issue-123</em> with the name of your feature branch):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout issue-123
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to branch &#39;issue-123&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git fetch upstream
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Counting objects: 69, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Compressing objects: 100% (23/23), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Total 69 (delta 49), reused 39 (delta 39), pack-reused 7
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Unpacking objects: 100% (69/69), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>From https://github.com/NeuroDesk/neurocontainers/
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   69fa600..43e21f6  master     -&gt; upstream/master
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git rebase upstream/master
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>First, rewinding head to replay your work on top of it...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Applying: troubleshooting tip about provisioning
</span></span></span></code></pre></div><h3 id=step-2-push-your-updated-branch-to-your-remote-fork>Step 2: Push your updated branch to your remote fork</h3><p>Once you&rsquo;ve updated your local feature branch, push the changes to GitHub:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin issue-123
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Counting objects: 6, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Delta compression using up to 4 threads.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Compressing objects: 100% (4/4), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Writing objects: 100% (6/6), 658 bytes | 0 bytes/s, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Total 6 (delta 3), reused 0 (delta 0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Resolving deltas: 100% (3/3), completed with 1 local objects.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To git@github.com:christi3k/neurocontainers.git
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> + 2d49e2d...bfb2433 issue-123 -&gt; issue-123
</span></span></span></code></pre></div><p>If your push is rejected with error <strong>failed to push some refs</strong> then you need
to prefix the name of your branch with a <code>+</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin +issue-123
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Counting objects: 6, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Delta compression using up to 4 threads.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Compressing objects: 100% (4/4), done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Writing objects: 100% (6/6), 658 bytes | 0 bytes/s, done.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Total 6 (delta 3), reused 0 (delta 0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>remote: Resolving deltas: 100% (3/3), completed with 1 local objects.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To git@github.com:christi3k/neurocontainers.git
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> + 2d49e2d...bfb2433 issue-123 -&gt; issue-123 (forced update)
</span></span></span></code></pre></div><p>This is perfectly okay to do on your own feature branches, especially if you&rsquo;re
the only one making changes to the branch. If others are working along with
you, they might run into complications when they retrieve your changes because
anyone who has based their changes off a branch you rebase will have to do a
complicated rebase.</p><h3 id=step-3-open-the-pull-request>Step 3: Open the pull request</h3><p>If you&rsquo;ve never created a pull request or need a refresher, take a look at
GitHub&rsquo;s article <a href=https://help.github.com/en/articles/creating-a-pull-request-from-a-fork>creating a pull request from a
fork</a>.
Note: <strong>Pull request titles are different from commit messages.</strong> Commit
messages can be edited with <code>git commit --amend</code>, <code>git rebase -i</code>, etc., while
the title of a pull request can only be edited via GitHub.</p><h2 id=update-a-pull-request>Update a pull request</h2><p>As you make progress on your feature or bugfix, your pull request, once
submitted, will be updated each time you <a href=../workflow#push-your-commits-to-github>push commits</a> to
your remote branch. This means you can keep your pull request open as long as
you need, rather than closing and opening new ones for the same feature or
bugfix.</p><p>It&rsquo;s a good idea to keep your pull request mergeable with neurocontainer upstream by
frequently fetching, rebasing, and pushing changes. See <a href=../workflow#keep-your-fork-up-to-date>keep your fork up to
date</a> for details. You might also find this excellent
article <a href=https://github.com/edx/edx-platform/wiki/How-to-Rebase-a-Pull-Request>How to Rebase a Pull Request</a> helpful.</p><p>And, as you address review comments others have made, we recommend posting a
follow-up comment in which you: a) ask for any clarifications you need, b)
explain to the reviewer how you solved any problems they mentioned, and c) ask
for another review.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-be505b3d9e340052f832ece047956369>4.6 - Troubleshooting</h1><div class=lead>Troubleshoot commit issue with Git</div><h2 id=undo-a-merge-commit>Undo a merge commit</h2><p>A merge commit is a special type of commit that has two parent commits. It&rsquo;s
created by Git when you merge one branch into another and the last commit on
your current branch is not a direct ancestor of the branch you are trying to
merge in. This happens quite often in a busy project like NeuroDesk where there are
many contributors because upstream/neurocontainer will have new commits while you&rsquo;re
working on a feature or bugfix. In order for Git to merge your changes and the
changes that have occurred on neurocontainer/upstream since you first started your work,
it must perform a three-way merge and create a merge commit.</p><p>neurocontainer uses a forked-repo, rebase-oriented workflow.</p><p>A merge commit is usually created when you&rsquo;ve run <code>git pull</code> or <code>git merge</code>.
You&rsquo;ll know you&rsquo;re creating a merge commit if you&rsquo;re prompted for a commit
message and the default is something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Merge branch &#39;master&#39; of https://github.com/NeuroDesk/neurocontainer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Please enter a commit message to explain why this merge is necessary,
</span></span><span style=display:flex><span># especially if it merges an updated upstream into a topic branch.
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span># Lines starting with &#39;#&#39; will be ignored, and an empty message aborts
</span></span><span style=display:flex><span># the commit.
</span></span></code></pre></div><p>And the first entry for <code>git log</code> will show something like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>commit e5f8211a565a5a5448b93e98ed56415255546f94
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Merge: 13bea0e e0c10ed
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Author: Christie Koehler &lt;ck@christi3k.net&gt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Date:   Mon Oct 10 13:25:51 2016 -0700
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>    Merge branch &#39;master&#39; of https://github.com/NeuroDesk/neurocontainer
</span></span></span></code></pre></div><p>Some graphical Git clients may also create merge commits.</p><p>To undo a merge commit, first run <code>git reflog</code> to identify the commit you want
to roll back to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reflog
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>e5f8211 HEAD@{0}: pull upstream master: Merge made by the &#39;recursive&#39; strategy.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>13bea0e HEAD@{1}: commit: test commit for docs.
</span></span></span></code></pre></div><p>Reflog output will be long. The most recent Git refs will be listed at the top.
In the example above <code>e5f8211 HEAD@{0}:</code> is the merge commit made automatically
by <code>git pull</code> and <code>13bea0e HEAD@{1}:</code> is the last commit I made before running
<code>git pull</code>, the commit that I want to rollback to.</p><p>Once you&rsquo;d identified the ref you want to revert to, you can do so with <a href=https://git-scm.com/docs/git-reset>git
reset</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reset --hard 13bea0e
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>HEAD is now at 13bea0e test commit for docs.
</span></span></span></code></pre></div><p>:::{important}
<code>git reset --hard &lt;commit></code> will discard all changes in your
working directory and index since the commit you&rsquo;re resetting to with
<code>&lt;commit></code>. <em>This is the main way you can lose work in Git</em>. If you need
to keep any changes that are in your working directory or that you have
committed, use <code>git reset --merge &lt;commit></code> instead.
:::</p><p>You can also use the relative reflog <code>HEAD@{1}</code> instead of the commit hash,
just keep in mind that this changes as you run Git commands.</p><p>Now when you look at the output of <code>git reflog</code>, you should see that the tip of your branch points to your
last commit <code>13bea0e</code> before the merge:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reflog
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>13bea0e HEAD@{2}: reset: moving to HEAD@{1}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>e5f8211 HEAD@{3}: pull upstream master: Merge made by the &#39;recursive&#39; strategy.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>13bea0e HEAD@{4}: commit: test commit for docs.
</span></span></span></code></pre></div><p>And the first entry <code>git log</code> shows is this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>commit 13bea0e40197b1670e927a9eb05aaf50df9e8277
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Author: Christie Koehler &lt;ck@christi3k.net&gt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Date:   Mon Oct 10 13:25:38 2016 -0700
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>    test commit for docs.
</span></span></span></code></pre></div><h2 id=restore-a-lost-commit>Restore a lost commit</h2><p>We&rsquo;ve mentioned you can use <code>git reset --hard</code> to rollback to a previous
commit. What if you run <code>git reset --hard</code> and then realize you actually need
one or more of the commits you just discarded? No problem, you can restore them
with <code>git cherry-pick</code> (<a href=https://git-scm.com/docs/git-cherry-pick>docs</a>).</p><p>For example, let&rsquo;s say you just committed &ldquo;some work&rdquo; and your <code>git log</code> looks
like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>* 67aea58 (HEAD -&gt; master) some work
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* 13bea0e test commit for docs.
</span></span></span></code></pre></div><p>You then mistakenly run <code>git reset --hard 13bea0e</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reset --hard 13bea0e
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>HEAD is now at 13bea0e test commit for docs.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git log
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* 13bea0e (HEAD -&gt; master) test commit for docs.
</span></span></span></code></pre></div><p>And then realize you actually needed to keep commit 67aea58. First, use
<code>git reflog</code> to confirm that commit you want to restore and then run
<code>git cherry-pick &lt;commit></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git reflog
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>13bea0e HEAD@{0}: reset: moving to 13bea0e
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>67aea58 HEAD@{1}: commit: some work
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git cherry-pick 67aea58
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic> [master 67aea58] some work
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> Date: Thu Oct 13 11:51:19 2016 -0700
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> 1 file changed, 1 insertion(+)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> create mode 100644 test4.txt
</span></span></span></code></pre></div><h2 id=recover-from-a-git-rebase-failure>Recover from a <code>git rebase</code> failure</h2><p>One situation in which <code>git rebase</code> will fail and require you to intervene is
when your change, which Git will try to re-apply on top of new commits from
which ever branch you are rebasing on top of, is to code that has been changed
by those new commits.</p><p>For example, while I&rsquo;m working on a file, another contributor makes a change to
that file, submits a pull request and has their code merged into <code>master</code>.
Usually this is not a problem, but in this case the other contributor made a
change to a part of the file I also want to change. When I try to bring my
branch up to date with <code>git fetch</code> and then <code>git rebase upstream/master</code>, I see
the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>First, rewinding head to replay your work on top of it...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Applying: test change for docs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Using index info to reconstruct a base tree...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>M    README.md
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Falling back to patching base and 3-way merge...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Auto-merging README.md
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>CONFLICT (content): Merge conflict in README.md
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>error: Failed to merge in the changes.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Patch failed at 0001 test change for docs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>The copy of the patch that failed is found in: .git/rebase-apply/patch
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>When you have resolved this problem, run &#34;git rebase --continue&#34;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>If you prefer to skip this patch, run &#34;git rebase --skip&#34; instead.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>To check out the original branch and stop rebasing, run &#34;git rebase --abort&#34;.
</span></span></span></code></pre></div><p>This message tells me that Git was not able to apply my changes to README.md
after bringing in the new commits from upstream/master.</p><p>Running <code>git status</code> also gives me some information:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>rebase in progress; onto 5ae56e6
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>You are currently rebasing branch &#39;docs-test&#39; on &#39;5ae56e6&#39;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (fix conflicts and then run &#34;git rebase --continue&#34;)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git rebase --skip&#34; to skip this patch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git rebase --abort&#34; to check out the original branch)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Unmerged paths:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git reset HEAD &lt;file&gt;...&#34; to unstage)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  (use &#34;git add &lt;file&gt;...&#34; to mark resolution)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  both modified:   README.md
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>no changes added to commit (use &#34;git add&#34; and/or &#34;git commit -a&#34;)
</span></span></span></code></pre></div><p>To fix, open all the files with conflicts in your editor and decide which edits
should be applied. Git uses standard conflict-resolution (<code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code>, <code>=======</code>,
and <code>>>>>>>></code>) markers to indicate where in files there are conflicts.</p><p>Tip: You can see recent changes made to a file by running the following
commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git fetch upstream
</span></span><span style=display:flex><span>git log -p upstream/master -- /path/to/file
</span></span></code></pre></div><p>You can use this to compare the changes that you have made to a file with the
ones in upstream, helping you avoid undoing changes from a previous commit when
you are rebasing.</p><p>Once you&rsquo;ve done that, save the file(s), stage them with <code>git add</code> and then
continue the rebase with <code>git rebase --continue</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git add README.md
</span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git rebase --continue
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Applying: test change for docs
</span></span></span></code></pre></div><p>For help resolving merge conflicts, see <a href=https://git-scm.com/book/en/v2/Git-Branching-Basic-Branching-and-Merging#Basic-Merge-Conflicts>basic merge
conflicts</a>, <a href=https://git-scm.com/book/en/v2/Git-Tools-Advanced-Merging#_advanced_merging>advanced
merging</a>, and/or GitHub&rsquo;s help on <a href=https://help.github.com/en/articles/resolving-a-merge-conflict-using-the-command-line>how to resolve a
merge conflict</a>.</p><h2 id=working-from-multiple-computers>Working from multiple computers</h2><p>Working from multiple computers with neurocontainer and Git is fine, but you&rsquo;ll need to
pay attention and do a bit of work to ensure all of your work is readily
available.</p><p>Recall that most Git operations are local. When you commit your changes with
<code>git commit</code> they are safely stored in your <em>local</em> Git database only. That is,
until you <em>push</em> the commits to GitHub, they are only available on the computer
where you committed them.</p><p>So, before you stop working for the day, or before you switch computers, push
all of your commits to GitHub with <code>git push</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git push origin &lt;branchname&gt;
</span></span></code></pre></div><p>When you first start working on a new computer, you&rsquo;ll <a href=../cloning#step-1b-clone-to-your-machine>clone the neurocontainer
repository</a> and <a href=../cloning#step-1c-connect-your-fork-to-neurocontainers-upstream>connect it to neurocontainer
upstream</a>. A clone retrieves all current commits,
including the ones you pushed to GitHub from your other computer.</p><p>But if you&rsquo;re switching to another computer on which you have already cloned
neurocontainer, you need to update your local Git database with new refs from your
GitHub fork. You do this with <code>git fetch</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git fetch &lt;username&gt;
</span></span></code></pre></div><p>Ideally you should do this before you have made any commits on the same branch
on the second computer. Then you can <code>git merge</code> on whichever branch you need
to update:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> git checkout &lt;my-branch&gt;
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Switched to branch &#39;&lt;my-branch&gt;&#39;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> git merge origin/master
</span></span></code></pre></div><p><strong>If you have already made commits on the second computer that you need to
keep,</strong> you&rsquo;ll need to use <code>git log FETCH_HEAD</code> to identify that hashes of the
commits you want to keep and then <code>git cherry-pick &lt;commit></code> those commits into
whichever branch you need to update.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f706aedba5bc93ee895c966642b91365>4.7 - Menu entries</h1><div class=lead>Menu entries in neurodesktop</div><h2 id=menu-entry>Menu entry</h2><p>As we want to propose several versions of the tools, each piece of software should have its own submenu under <code>VNM Neuroimaging</code>.
To do so, you first have to add a submenu to <code>menus/vnm-applications.menu</code> by adding:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- [[Tool Name]] submenu --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;Menu&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;Name&gt;</span>[[Tool Name]]<span style=color:#204a87;font-weight:700>&lt;/Name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;Directory&gt;</span>vnm-[[tool-name]].directory<span style=color:#204a87;font-weight:700>&lt;/Directory&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;Include&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;And&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;Category&gt;</span>[[Tool-Name]]<span style=color:#204a87;font-weight:700>&lt;/Category&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/And&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/Include&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/Menu&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- End [[Tool Name]] --&gt;</span>
</span></span></code></pre></div><p>The following table shows the formatting rules to follow:</p><table><thead><tr><th>Placeholder</th><th>Rule</th><th>Example</th></tr></thead><tbody><tr><td><code>[[Tool name]]</code></td><td>Capitalized, spaces</td><td><code>ITK snap</code></td></tr><tr><td><code>[[tool-name]]</code></td><td>Lower case, no spaces (use <code>-</code> instead)</td><td><code>itk-snap</code> or <code>itksnap</code></td></tr><tr><td><code>[[Tool-name]]</code></td><td>Capitalized, no spaces (use <code>-</code> instead)</td><td><code>ITK-snap</code></td></tr></tbody></table><p>Next, we have to create the submenu itself as we referenced it by <code>vnm-[[tool-name]].directory</code>. To do so, create the file <code>menus/submenus/vnm-[[tool-name]].directory</code> and add the following information inside:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Directory</span>
</span></span></code></pre></div><p>If a specific icon is available in the <code>menus/icons</code> directory, replace <code>[[icon-name]]</code> by its name. Otherwise, use <code>vnm</code>.</p><h2 id=create-the-application>Create the application</h2><p>Finally, we have to create the actual application by creating the file <code>menus/applications/vnm-[[tool-name]]-[[0.0.0]].desktop</code>. The name of this file must contain the version of the tool (once again to allow multiple versions to live inside the same directory). Add the following description to this file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]] [[(Install only)]]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The description of what clicking on this application does. # This will be the tooltip of the application.</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The command used to run the application.</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool-name]]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true # or false</span>
</span></span></code></pre></div><p>The important part here is the value of <code>Exec</code>. If the tool is in the form of a singularity image, you should run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash /usr/share/fetch_and_run.sh <span style=color:#ce5c00;font-weight:700>[[</span>tool-name<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>0.0.0<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>YYYYMMDD<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>cmd<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>args<span style=color:#ce5c00;font-weight:700>]]</span>
</span></span></code></pre></div><p>What <code>fetch_and_run.sh</code> does is check if the image is already installed as a module. If not, it checks whether it can be installed or not (return <code>1</code> if not possible). After that, it installs the image as a module.
If <code>[[cmd]]</code> is specified, once the image is installed, it runs the command by giving the arguments from <code>[[args]]</code>.
Here are two examples for FreeSurfer and FreeView. This first one only installs the image as a module:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span>
</span></span></code></pre></div><p>And this does the same but runs FreeView afterward:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span> freeview
</span></span></code></pre></div><p>The resulting <code>.desktop</code> file corresponding to FreeView contains:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Start FreeView 6.0.1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 20200506 freeview</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/run.png</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeSurfer</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f89498a0fd2d201e1dc7e27d7be9f337>5 - Transparent Singularity</h1><div class=lead>For more advanced users who wish to use Transparent Singularity directly</div><p>Transparent singularity is here <a href=https://github.com/NeuroDesk/transparent-singularity/>https://github.com/NeuroDesk/transparent-singularity/</a></p><p>This project allows to use singularity containers transparently on HPCs, so that an application inside the container can be used without adjusting any scripts or pipelines (e.g. nipype).</p><h2 id=important-add-bind-points-to-bashrc-before-executing-this-script>Important: add bind points to .bashrc before executing this script</h2><p>This script expects that you have adjusted the Singularity Bindpoints in your .bashrc, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>export SINGULARITY_BINDPATH=&#34;/gpfs1/,/QRISdata,/data&#34;
</span></span></code></pre></div><h2 id=this-gives-you-a-list-of-all-tested-images-available-in-neurodesk>This gives you a list of all tested images available in neurodesk:</h2><p><a href=https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt>https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>curl -s https://raw.githubusercontent.com/NeuroDesk/neurodesk/master/cvmfs/log.txt
</span></span></code></pre></div><h2 id=clone-repo-into-a-folder-with-the-intented-image-name>Clone repo into a folder with the intented image name</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>git clone https://github.com/NeuroDesk/transparent-singularity convert3d_1.0.0_20210104
</span></span></code></pre></div><h2 id=install>Install</h2><p>This will create scripts for every binary in the container located in the $DEPLOY_PATH inside the container. It will also create activate and deactivate scripts and module files for lmod (<a href=https://lmod.readthedocs.io/en/latest/>https://lmod.readthedocs.io/en/latest/</a>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cd convert3d_1.0.0_20210104
</span></span><span style=display:flex><span>./run_transparent_singularity.sh convert3d_1.0.0_20210104
</span></span></code></pre></div><h2 id=options-for-transparent-singularity>Options for Transparent singularity:</h2><ul><li><code>--storage</code> - this option can be used to force a download from docker, e.g.: <code>--storage docker</code></li><li><code>--container</code> - this option can be used to explicitly define the container name to be downloaded</li><li><code>--unpack</code> - this will unpack the singularity container so it can be used on systems that do not allow to open simg / sif files for security reasons, e.g.: <code>--unpack true</code></li><li><code>--singularity-opts</code> - this will be passed on to the singularity call, e.g.: <code>--singularity-opts '--bind /cvmfs'</code></li></ul><h1 id=use-in-module-system-lmod>Use in module system LMOD</h1><p>Add the module folder path to $MODULEPATH</p><h1 id=manual-activation-and-deactivation-in-case-module-system-is-not-available-this-will-add-the-paths-to-the-bashrc>Manual activation and deactivation (in case module system is not available). This will add the paths to the .bashrc</h1><h2 id=activate>Activate</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>source activate_convert3d_1.0.0_20210104.sh
</span></span></code></pre></div><h2 id=deactivate>Deactivate</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>source deactivate_convert3d_1.0.0_20210104.sif.sh
</span></span></code></pre></div><h2 id=uninstall-container-and-cleanup>Uninstall container and cleanup</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>./ts_uninstall.sh
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9dfb256e35d7dd91e05a33ec675f72e4>6 - Neurodesk CVMFS</h1><div class=lead>How to interact with our CVMFS service.</div></div><div class=td-content><h1 id=pg-7d2cf5c0520f7ea412450bf2c795e035>6.1 - Setup CVMFS Proxy</h1><div class=lead>Setup CVMFS Proxy server</div><p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy. We currently don&rsquo;t run any proxy servers but it would be important for using it on a cluster.</p><pre class="language-batch command-line" data-prompt=">" data-output=2-4>
<code>docker run --shm-size=1gb -it --privileged --name neurodesktop `
-v C:/neurodesktop-storage:/neurodesktop-storage -p 8080:8080 `
-h neurodesktop-20220701 `
vnmd/neurodesktop:20220701</code>
</pre><h1 id=setup-a-cvmfs-proxy-server>Setup a CVMFS proxy server</h1><pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install -y squid</code>
</pre><p>Open the <code>squid.conf</code>and use the following configuration</p><pre class="language-shell command-line" data-prompt=$>
<code>sudo vi /etc/squid/squid.conf</code>
</pre><pre class=language-shell>
<code># List of local IP addresses (separate IPs and/or CIDR notation) allowed to access your local proxy
#acl local_nodes src YOUR_CLIENT_IPS

# Destination domains that are allowed
#acl stratum_ones dstdomain .YOURDOMAIN.ORG
#acl stratum_ones dstdom_regex YOUR_REGEX
acl stratum_ones dst 140.238.211.92

# Squid port
http_port 3128

# Deny access to anything which is not part of our stratum_ones ACL.
http_access deny !stratum_ones

# Only allow access from our local machines
#http_access allow local_nodes
http_access allow localhost

# Finally, deny all other access to this proxy
http_access deny all

minimum_expiry_time 0
maximum_object_size 1024 MB

cache_mem 128 MB
maximum_object_size_in_memory 128 KB
# 5 GB disk cache
cache_dir ufs /var/spool/squid 5000 16 256
</code>
</pre><pre class="language-shell command-line" data-prompt=$>
<code>sudo squid -k parse
sudo systemctl start squid
sudo systemctl enable squid
sudo systemctl status squid
sudo systemctl restart squid</code>
</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-d12eca793afb912a040cd1c047606b56>6.2 - CVMFS architecture</h1><div class=lead>CVMFS architecture</div><p>We store our singuarlity containers unpacked on CVMFS. We tried the DUCC tool in the beginning, but it was causing too many issues with dockerhub and we were rate limited. The script to unpack our singularity containers is here: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh>https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh</a></p><p>It gets called by a cronjob on the CVMFS Stratum 0 server and relies on the log.txt file being updated via an action in the neurocommand repository (<a href=https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh>https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh</a>)</p><p>The Stratum 1 servers then pull this repo from Stratum 0 and our desktops mount these repos (configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a>)</p><p>The startup script (<a href=https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh>https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh</a>) sets up CVMFS and tests which server is fastest during the container startup.</p><p>This can also be done manually:</p><pre class="language-shell command-line" data-prompt=$><code>sudo cvmfs_talk -i neurodesk.ardc.edu.au host info
sudo cvmfs_talk -i neurodesk.ardc.edu.au host probe
cvmfs_config stat -v neurodesk.ardc.edu.au</code></pre><blockquote></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-9110e9d9e3591f58026d3d52fc7e72cb>6.3 - Setup Stratum 0 server</h1><div class=lead>Host a Stratum 0 server</div><h2 id=setup-a-stratum-0-server>Setup a Stratum 0 server:</h2><h3 id=setup-storage>Setup Storage</h3><p>(would object storage be better? -> see comment below under next iteration ideas)</p><pre class="language-shell command-line" data-prompt=$>
<code>lsblk -l
sudo mkfs.ext4 /dev/vdb
sudo mkdir /storage
sudo mount /dev/vdb /storage/ -t auto
sudo chown ec2-user /storage/
sudo chmod a+rwx /storage/</code>
</pre><pre class="language-shell command-line" data-prompt=$ data-output=2>
<code>sudo vi /etc/fstab
/dev/vdb  /storage    auto    defaults,nofail   0  2</code>
</pre><h3 id=setup-server>Setup server</h3><pre class="language-shell command-line" data-prompt=$ data-output="41, 44-52">
<code>sudo yum install vim htop gcc git screen
sudo timedatectl set-timezone Australia/Brisbane

sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs cvmfs-server

sudo systemctl enable httpd
sudo systemctl restart httpd

# sudo systemctl stop firewalld 

# restore keys:
sudo mkdir /etc/cvmfs/keys/incoming
sudo chmod a+rwx /etc/cvmfs/keys/incoming
cd connections/cvmfs_keys/
scp neuro* ec2-user@203.101.226.164:/etc/cvmfs/keys/incoming
sudo mv /etc/cvmfs/keys/incoming/* /etc/cvmfs/keys/

#backup keys: 
#mkdir cvmfs_keys
#scp opc@158.101.127.61:/etc/cvmfs/keys/neuro* .

sudo cvmfs_server mkfs -o $USER neurodesk.ardc.edu.au

cd /storage
sudo mkdir -p cvmfs-storage/srv/
cd /srv/
sudo mv cvmfs/ /storage/cvmfs-storage/srv/
sudo ln -s /storage/cvmfs-storage/srv/cvmfs/

cd /var/spool
sudo mkdir /storage/spool
sudo mv cvmfs/ /storage/spool/
sudo ln -s  /storage/spool/cvmfs .

cvmfs_server transaction neurodesk.ardc.edu.au

cvmfs_server publish neurodesk.ardc.edu.au</code>
</pre><pre class="language-shell command-line" data-prompt=$ data-ouput=2>
<code>sudo vi /etc/cron.d/cvmfs_resign</code>
</pre><pre class=language-shell>
<code>0 11 * * 1 root /usr/bin/cvmfs_server resign neurodesk.ardc.edu.au</code>
</pre><pre class="language-shell command-line" data-prompt=$ data-ouput=2>
<code>cat /etc/cvmfs/keys/neurodesk.ardc.edu.au.pub</code>
</pre><pre class=language-shell>
<code>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuV9JBs9uXBR83qUs7AiE
nSQfvh6VCdNigVzOfRMol5cXsYq3cFy/Vn1Nt+7SGpDTQArQieZo4eWC9ww2oLq0
vY1pWyAms3Y4i+IUmMbwNifDU4GQ1KN9u4zl9Peun2YQCLE7mjC0ZLQtLM7Q0Z8h
NwP8jRJTN+u8mRKzkyxfSMLscVMKhm2pAwnT1zB9i3bzVV+FSnidXq8rnnzNHMgv
tfqx1h0gVyTeodToeFeGG5vq69wGZlwEwBJWVRGzzr+a8dWNBFMJ1HxamrBEBW4P
AxOKGHmQHTGbo+tdV/K6ZxZ2Ry+PVedNmbON/EPaGlI8Vd0fascACfByqqeUEhAB
dQIDAQAB
-----END PUBLIC KEY-----</code>
</pre><h2 id=next-iteration-of-this>Next iteration of this:</h2><h3 id=use-object-storage>use object storage?</h3><ul><li>current implementation uses block storage, but this makes increasing the volume size a bit more work</li><li>we coulddn&rsquo;t get object storage to work on Oracle as it assumes AWS S3</li></ul><h3 id=optimize-settings-for-repositories-for-container-images>Optimize settings for repositories for Container Images</h3><p>from the CVMFS documentation:
Repositories containing Linux container image contents (that is: container root file systems) should use overlayfs as a union file system and have the following configuration:</p><pre><code>CVMFS_INCLUDE_XATTRS=true
CVMFS_VIRTUAL_DIR=true
</code></pre><p>Extended attributes of files, such as file capabilities and SElinux attributes, are recorded. And previous file system revisions can be accessed from the clients.</p><h2 id=currently-not-used>Currently not used</h2><p>We tested the DUCC tool in the beginning, but it was leading to too many docker pulls and we therefore replaced it with our own script: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh>https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh</a></p><p>This is the old DUCC setup</p><pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install cvmfs-ducc.x86_64
sudo -i
dnf install -y yum-utils 
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf install docker-ce docker-ce-cli containerd.io
systemctl enable docker
systemctl start docker
docker version
docker info

# leave root mode

sudo groupadd docker
sudo usermod -aG docker $USER
sudo chown root:docker /var/run/docker.sock
newgrp docker


vi convert_appsjson_to_wishlist.sh
export DUCC_DOCKER_REGISTRY_PASS=configure_secret_password_here_and_dont_push_to_github
cd neurodesk
git pull
./gen_cvmfs_wishlist.sh
cvmfs_ducc convert recipe_neurodesk_auto.yaml
cd ..


chmod +x convert_appsjson_to_wishlist.sh

git clone https://github.com/NeuroDesk/neurodesk/

# setup cron job
sudo vi /etc/cron.d/cvmfs_dockerpull
*/5 * * * * opc cd ~ && bash /home/opc/convert_appsjson_to_wishlist.sh



#vi recipe.yaml

##version: 1
#user: vnmd
#cvmfs_repo: neurodesk.ardc.edu.au
#output_format: '$(scheme)://$(registry)/vnmd/thin_$(image)'
#input:
#- 'https://registry.hub.docker.com/vnmd/tgvqsm_1.0.0:20210119'
#- 'https://registry.hub.docker.com/vnmd/itksnap_3.8.0:20201208'


#cvmfs_ducc convert recipe_neurodesk.yaml
#cvmfs_ducc convert recipe_unpacked.yaml</code>
</pre><blockquote></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-c25efc2b343b28af52b4173ce3a803a3>6.4 - Setup Stratum 1 server</h1><div class=lead>Host a Stratum 1 server</div><p>The stratum 1 servers for the desktop are configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a></p><p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy.</p><h1 id=setup-a-stratum-1-server>Setup a Stratum 1 server:</h1><pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs-server squid
sudo yum install -y python3-mod_wsgi 

sudo sed -i 's/Listen 80/Listen 127.0.0.1:8080/' /etc/httpd/conf/httpd.conf

set +H
echo "http_port 80 accel" | sudo tee /etc/squid/squid.conf
echo "http_port 8000 accel" | sudo tee -a /etc/squid/squid.conf
echo "http_access allow all" | sudo tee -a /etc/squid/squid.conf
echo "cache_peer 127.0.0.1 parent 8080 0 no-query originserver" | sudo tee -a /etc/squid/squid.conf
echo "acl CVMFSAPI urlpath_regex ^/cvmfs/[^/]*/api/" | sudo tee -a /etc/squid/squid.conf
echo "cache deny !CVMFSAPI" | sudo tee -a /etc/squid/squid.conf
echo "cache_mem 128 MB" | sudo tee -a /etc/squid/squid.conf

sudo systemctl start httpd
sudo systemctl start squid
sudo systemctl enable httpd
sudo systemctl enable squid

echo 'CVMFS_GEO_LICENSE_KEY=kGepdzqbAP4fjf5X' | sudo tee -a /etc/cvmfs/server.local
sudo chmod 600 /etc/cvmfs/server.local

sudo mkdir -p /etc/cvmfs/keys/ardc.edu.au/

echo "-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwUPEmxDp217SAtZxaBep
Bi2TQcLoh5AJ//HSIz68ypjOGFjwExGlHb95Frhu1SpcH5OASbV+jJ60oEBLi3sD
qA6rGYt9kVi90lWvEjQnhBkPb0uWcp1gNqQAUocybCzHvoiG3fUzAe259CrK09qR
pX8sZhgK3eHlfx4ycyMiIQeg66AHlgVCJ2fKa6fl1vnh6adJEPULmn6vZnevvUke
I6U1VcYTKm5dPMrOlY/fGimKlyWvivzVv1laa5TAR2Dt4CfdQncOz+rkXmWjLjkD
87WMiTgtKybsmMLb2yCGSgLSArlSWhbMA0MaZSzAwE9PJKCCMvTANo5644zc8jBe
NQIDAQAB
-----END PUBLIC KEY-----" | sudo tee /etc/cvmfs/keys/ardc.edu.au/neurodesk.ardc.edu.au.pub


sudo cvmfs_server add-replica -o $USER http://203.101.226.164/cvmfs/neurodesk.ardc.edu.au /etc/cvmfs/keys/ardc.edu.au

# CVMFS will store everything in /srv/cvmfs so make sure there is enough space or create a symlink to a bigger storage volume
# e.g.:



sudo cvmfs_server snapshot neurodesk.ardc.edu.au


echo "/var/log/cvmfs/*.log {
    weekly
    missingok
    notifempty
}" | sudo tee /etc/logrotate.d/cvmfs


echo '*/5 * * * * root output=$(/usr/bin/cvmfs_server snapshot -a -i 2>&1) || echo "$output" ' | sudo tee /etc/cron.d/cvmfs_stratum1_snapshot

sudo yum install iptables
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000

sudo systemctl disable firewalld 
sudo systemctl stop firewalld 
# make sure that port 80 is open in the real firewall

sudo cvmfs_server update-geodb</code>
</pre><blockquote></blockquote></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/neuro_desk aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label><a class=text-white target=_blank rel=noopener href aria-label><i></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dicussion Forum (requires github login)" aria-label="Dicussion Forum (requires github login)"><a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk/neurodesk.github.io/discussions aria-label="Dicussion Forum (requires github login)"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.2b242016bd393aa86ff3b4500b2baae3b55d65f622435861b9338518eb4a5f69.js integrity="sha256-KyQgFr05Oqhv87RQCyuq47VdZfYiQ1hhuTOFGOtKX2k=" crossorigin=anonymous></script>
<script src=/js/prism.js></script></body></html>